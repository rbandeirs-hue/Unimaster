{% extends "base.html" %}
{% block title %}Lista de Turmas{% endblock %}

{% block content %}

<style>
    .container {
        max-width: 1200px;
    }
</style>

<div class="container my-4 px-2 px-sm-3">
    <!-- Botão de Voltar para o Gerenciamento da Academia -->
    {% set back_url = back_url or get_back_url_default() %}
{% include 'components/botao_voltar.html' %}
    
    <!-- Título e Introdução -->
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
        <div>
            <h2 class="h4 fw-bold mb-1">Turmas Cadastradas</h2>
            <p class="text-muted small mb-0">Gerencie e visualize todas as turmas ativas</p>
        </div>
        <!-- Botão para Nova Turma -->
        <a href="{{ url_for('turmas.cadastro_turma', academia_id=academia_id, next=request.full_path) if (academia_id is defined and academia_id) else url_for('turmas.cadastro_turma', next=request.full_path) }}" class="btn btn-sm btn-dark">
            <i class="bi bi-plus-lg me-1"></i> Nova Turma
        </a>
    </div>

    {% if academias|length > 1 %}
    <div class="mb-3">
        <form method="GET" class="d-flex align-items-center gap-2 flex-wrap">
            <label class="form-label mb-0 small fw-semibold text-muted">Academia:</label>
            <select name="academia_id" class="form-select form-select-sm" style="max-width: 280px;" onchange="this.form.submit()">
                {% for ac in academias %}
                <option value="{{ ac.id }}" {% if ac.id == academia_id %}selected{% endif %}>{{ ac.nome }}</option>
                {% endfor %}
            </select>
            {% if busca %}<input type="hidden" name="busca" value="{{ busca }}">{% endif %}
        </form>
    </div>
    {% endif %}

    <!-- Filtro de Busca -->
    <div class="mb-4">
        <form method="GET" action="{{ url_for('turmas.lista_turmas') }}" class="d-flex gap-2">
            {% if academia_id %}<input type="hidden" name="academia_id" value="{{ academia_id }}">{% endif %}
            <input type="text" name="busca" class="form-control form-control-sm"
                placeholder="Buscar turma pelo nome, professor ou horário..." 
                value="{{ busca if busca is not none }}">
            <button type="submit" class="btn btn-sm btn-outline-dark">
                <i class="bi bi-search"></i>
            </button>
        </form>
    </div>

    <!-- Cards de Turmas -->
    {% if turmas %}
    <style>
    .turma-card { 
        transition: all 0.2s ease; 
        border-radius: 10px; 
        border-width: 2px;
        background: #fff;
    }
    .turma-card:hover { 
        transform: translateY(-4px); 
        box-shadow: 0 8px 20px rgba(0,0,0,0.12) !important; 
    }
    .turma-card.border-primary { border-color: #0d6efd; }
    .turma-card.border-info { border-color: #0dcaf0; }
    .turma-card.border-success { border-color: #198754; }
    .turma-card.border-warning { border-color: #ffc107; }
    .turma-card.border-secondary { border-color: #6c757d; }
    .turma-card .card-body { padding: 1.25rem; }
    .turma-card .card-title { 
        font-size: 1rem; 
        font-weight: 600;
        line-height: 1.4; 
        color: #212529;
        margin-bottom: 0.75rem;
    }
    .turma-card .info-item { 
        font-size: 0.8125rem; 
        color: #6c757d; 
        padding: 0.375rem 0; 
        display: flex; 
        align-items: center; 
        gap: 0.5rem; 
    }
    .turma-card .info-item i { 
        width: 16px; 
        color: #6c757d; 
        flex-shrink: 0; 
        font-size: 0.875rem;
    }
    .turma-card .badges-row { 
        display: flex; 
        flex-wrap: wrap; 
        gap: 0.375rem; 
        margin-top: 0.75rem; 
    }
    .turma-card .badge {
        font-size: 0.75rem;
        font-weight: 500;
        padding: 0.25rem 0.5rem;
        background-color: #f8f9fa;
        color: #495057;
        border: 1px solid #e9ecef;
    }
    .turma-card .actions-row { 
        margin-top: 1rem; 
        padding-top: 1rem; 
        border-top: 1px solid #f1f3f5; 
        display: flex;
        gap: 0.375rem;
    }
    .turma-card .actions-row .btn {
        font-size: 0.75rem;
        padding: 0.375rem 0.625rem;
        border-radius: 6px;
        font-weight: 500;
    }
    .turma-card .modalidade-badge {
        font-size: 0.6875rem;
        padding: 0.2rem 0.4rem;
        background-color: #f8f9fa;
        color: #6c757d;
        border: 1px solid #e9ecef;
    }
    .section-title {
        font-size: 0.8125rem;
        font-weight: 600;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 1rem;
        margin-top: 0.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #f1f3f5;
    }
    @media (max-width: 767.98px) {
        .turma-card .edit-desktop { display: none !important; }
        .turma-card .actions-row {
            flex-direction: column;
        }
        .turma-card .actions-row .btn {
            width: 100%;
        }
        .section-title {
            margin-top: 1.5rem;
        }
        .section-title:first-child {
            margin-top: 0;
        }
    }
    @media (min-width: 768px) {
        .turma-card .edit-mobile { display: none !important; }
    }
    </style>
    <div class="row g-3">
        {% for modalidade_nome, turmas_grupo in turmas_agrupadas %}
        <div class="col-12">
            <h6 class="section-title mb-3">{{ modalidade_nome }}</h6>
        </div>
        {% for turma in turmas_grupo %}
        <div class="col-xl-4 col-lg-4 col-md-6 col-12">
            {% set border_colors = ['border-primary', 'border-info', 'border-success', 'border-warning', 'border-secondary'] %}
            {% set border_color = border_colors[loop.index0 % border_colors|length] %}
            <div class="card h-100 turma-card shadow-sm {{ border_color }}">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h5 class="card-title mb-0">{{ turma.Nome }}</h5>
                        <div class="d-flex align-items-center gap-2">
                            {% if turma.modalidade_nome and turma.modalidade_nome != 'Sem modalidade' %}
                            <span class="modalidade-badge">{{ turma.modalidade_nome }}</span>
                            {% endif %}
                            <a href="{{ url_for('turmas.editar_turma', turma_id=turma.TurmaID, next=request.full_path) }}" 
                               class="btn btn-sm btn-link text-muted p-0 edit-mobile" 
                               style="font-size: 0.875rem; text-decoration: none;" 
                               title="Editar Turma">
                                <i class="bi bi-pencil"></i>
                            </a>
                        </div>
                    </div>
                    <div class="info-item">
                        <i class="bi bi-clock"></i>
                        <span>{{ turma.horario_display or turma.DiasHorario or '—' }}</span>
                    </div>
                    <div class="info-item">
                        <i class="bi bi-person"></i>
                        <span>{{ turma.professor_responsavel_nome or '—' }}</span>
                    </div>
                    <div class="badges-row">
                        {% if turma.IdadeMin and turma.IdadeMax %}
                        <span class="badge">{{ turma.IdadeMin }}-{{ turma.IdadeMax }} anos</span>
                        {% endif %}
                        <span class="badge {% if turma.vagas_cheia %}text-danger{% else %}text-success{% endif %}">
                            {% if turma.vagas_ilimitada %}ilimitada{% else %}{{ turma.vagas_display }}{% endif %}
                        </span>
                    </div>
                    <div class="actions-row">
                        <button type="button" class="btn btn-sm btn-dark flex-grow-1 {% if not turma.pode_matricular %}disabled{% endif %}" 
                            title="{% if not turma.pode_matricular %}Vagas esgotadas{% else %}Matricular aluno{% endif %}"
                            {% if turma.pode_matricular %}data-bs-toggle="modal" data-bs-target="#modalMatricular"{% endif %}
                            data-turma-id="{{ turma.TurmaID }}" data-turma-nome="{{ turma.Nome }}">
                            <i class="bi bi-person-plus me-1"></i> Matricular
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-dark flex-grow-1" 
                            title="Ver alunos vinculados"
                            data-bs-toggle="modal" data-bs-target="#modalVinculados"
                            data-turma-id="{{ turma.TurmaID }}" data-turma-nome="{{ turma.Nome }}">
                            <i class="bi bi-people me-1"></i> Alunos
                        </button>
                        <a href="{{ url_for('turmas.editar_turma', turma_id=turma.TurmaID, next=request.full_path) }}"
                            class="btn btn-sm btn-outline-dark edit-desktop" 
                            title="Editar Turma"
                            style="min-width: 38px;">
                            <i class="bi bi-pencil"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
        {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-5">
        <i class="bi bi-journal-x text-muted" style="font-size: 3rem;"></i>
        <p class="mt-3 mb-1 fw-semibold">Nenhuma turma encontrada</p>
        {% if busca %}
        <p class="text-muted small">Tente um termo de busca diferente ou <a href="{{ url_for('turmas.lista_turmas') }}" class="text-decoration-none">limpe o filtro</a></p>
        {% else %}
        <p class="text-muted small">Que tal <a href="{{ url_for('turmas.cadastro_turma', next=request.full_path) }}" class="text-decoration-none">cadastrar a primeira turma</a> agora?</p>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- Modal Matricular Aluno -->
<div class="modal fade" id="modalMatricular" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-person-plus-fill me-2"></i>Matricular aluno em <span id="modalMatricularTurmaNome"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <!-- Botão de alternância entre modo normal e exceção -->
        <div class="d-flex gap-2 mb-3">
          <button type="button" class="btn btn-sm btn-outline-primary active" id="btnModoNormal" onclick="alternarModoMatricula('normal')">
            <i class="bi bi-list-check"></i> Normal
          </button>
          <button type="button" class="btn btn-sm btn-outline-warning" id="btnModoExcecao" onclick="alternarModoMatricula('excecao')">
            <i class="bi bi-exclamation-triangle"></i> Exceção
          </button>
        </div>
        
        <!-- Campo de busca por nome (modo exceção) -->
        <div id="buscaExcecao" style="display:none;" class="mb-3">
          <label class="form-label small fw-semibold">Buscar aluno por nome:</label>
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input type="text" class="form-control" id="inputBuscaAluno" placeholder="Digite o nome do aluno..." autocomplete="off">
          </div>
          <small class="text-muted">Busca dinâmica - alunos independente da idade</small>
        </div>
        
        <div id="modalMatricularLoading" class="text-center py-4">
          <div class="spinner-border text-primary" role="status"></div>
          <p class="mt-2 text-muted">Carregando alunos...</p>
        </div>
        <div id="modalMatricularLista" class="row g-2" style="display:none;"></div>
        <div id="modalMatricularVazio" class="text-center py-4 text-muted" style="display:none;">
          <i class="bi bi-person-x fs-1"></i>
          <p class="mb-0">Nenhum aluno disponível (todos já matriculados ou fora da faixa etária).</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Ver Alunos Vinculados -->
<div class="modal fade" id="modalVinculados" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-people-fill me-2"></i>Alunos em <span id="modalVinculadosTurmaNome"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="modalVinculadosLoading" class="text-center py-4">
          <div class="spinner-border text-primary" role="status"></div>
          <p class="mt-2 text-muted">Carregando...</p>
        </div>
        <div id="modalVinculadosLista" class="row g-2" style="display:none;"></div>
        <div id="modalVinculadosVazio" class="text-center py-4 text-muted" style="display:none;">
          <i class="bi bi-person-x fs-1"></i>
          <p class="mb-0">Nenhum aluno matriculado nesta turma.</p>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
#modalMatricular .modal-body, #modalVinculados .modal-body {
  max-height: 70vh;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}
@media (max-width: 575.98px) {
  #modalMatricular .modal-body, #modalVinculados .modal-body {
    max-height: 60vh;
  }
}
.aluno-mini-card {
  cursor: pointer;
  border-radius: 10px;
  padding: 0.75rem;
  border: 2px solid #e9ecef;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 0.75rem;
}
.aluno-mini-card:hover { border-color: #0d6efd; background: #f8f9fa; }
.aluno-mini-card .foto-mini {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  object-fit: cover;
  background: #e9ecef;
}
.aluno-mini-card .foto-mini-placeholder {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background: #e9ecef;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #6c757d;
}
.aluno-mini-card .nome-mini { font-weight: 600; margin: 0; }
.aluno-mini-card.readonly { cursor: default; }
.aluno-mini-card.readonly:hover { border-color: #e9ecef; background: transparent; }
.aluno-mini-card-vinculado {
  position: relative;
  cursor: default;
  border-radius: 10px;
  padding: 0.75rem 2.5rem 0.75rem 0.75rem;
  border: 2px solid #e9ecef;
  display: flex;
  align-items: center;
  gap: 0.75rem;
}
.aluno-mini-card-vinculado .foto-mini,
.aluno-mini-card-vinculado .foto-mini-placeholder {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  object-fit: cover;
  background: #e9ecef;
}
.aluno-mini-card-vinculado .foto-mini-placeholder {
  display: flex;
  align-items: center;
  justify-content: center;
  color: #6c757d;
}
.aluno-mini-card-vinculado .nome-mini { font-weight: 600; margin: 0; flex: 1; }
.aluno-mini-card-vinculado .btn-remover-turma {
  position: absolute;
  top: 0.35rem;
  right: 0.35rem;
  padding: 0.2rem 0.35rem;
  font-size: 0.75rem;
  line-height: 1;
}
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (el) { return new bootstrap.Tooltip(el); });

        var urlAlunosDisponiveis = "{{ url_for('turmas.alunos_disponiveis_turma', turma_id=999) }}";
        var urlAlunosVinculados = "{{ url_for('turmas.alunos_vinculados_turma', turma_id=999) }}";
        var urlMatricularBase = "{{ url_for('turmas.matricular_aluno', turma_id=999, aluno_id=888) }}";
        var urlRemoverBase = "{{ url_for('turmas.remover_aluno_turma', turma_id=999, aluno_id=888) }}";
        var urlBuscarAlunoExcecao = "{{ url_for('turmas.buscar_aluno_excecao', turma_id=999) }}";
        var matricularModal = document.getElementById('modalMatricular');
        var vinculadosModal = document.getElementById('modalVinculados');
        var modoMatriculaAtual = 'normal';
        var turmaIdAtual = null;

        function renderAlunoCard(a, clickHandler, readonly) {
            var div = document.createElement('div');
            div.className = 'col-12 col-md-6 col-lg-4';
            var card = document.createElement('div');
            card.className = 'aluno-mini-card' + (readonly ? ' readonly' : '');
            var foto = a.foto_url
                ? '<img src="' + a.foto_url + '" class="foto-mini" alt="">'
                : '<div class="foto-mini-placeholder"><i class="bi bi-person-fill"></i></div>';
            card.innerHTML = foto + '<span class="nome-mini">' + (a.nome || '-') + '</span>';
            if (clickHandler) card.addEventListener('click', function () { clickHandler(a); });
            div.appendChild(card);
            return div;
        }

        function renderAlunoCardComRemover(a, turmaId, onRemovido) {
            var div = document.createElement('div');
            div.className = 'col-12 col-md-6 col-lg-4';
            var card = document.createElement('div');
            card.className = 'aluno-mini-card-vinculado position-relative';
            var foto = a.foto_url
                ? '<img src="' + a.foto_url + '" class="foto-mini" alt="">'
                : '<div class="foto-mini-placeholder"><i class="bi bi-person-fill"></i></div>';
            card.innerHTML = foto + '<span class="nome-mini">' + (a.nome || '-') + '</span>' +
                '<button type="button" class="btn-remover-turma btn btn-sm btn-outline-danger" title="Remover da turma"><i class="bi bi-x-lg"></i></button>';
            var btn = card.querySelector('.btn-remover-turma');
            btn.addEventListener('click', function (e) {
                e.stopPropagation();
                if (!confirm('Remover ' + (a.nome || 'este aluno') + ' desta turma?')) return;
                btn.disabled = true;
                fetch(urlRemoverBase.replace('999', turmaId).replace('888', a.id), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
                    credentials: 'same-origin'
                }).then(function (res) { return res.json(); })
                  .then(function (data) {
                    if (data.ok) {
                        div.remove();
                        if (typeof onRemovido === 'function') onRemovido();
                        var container = document.querySelector('.toast-container') || document.body;
                        var t = document.createElement('div');
                        t.className = 'toast align-items-center text-bg-success border-0 mb-2';
                        t.setAttribute('role', 'alert');
                        t.setAttribute('aria-live', 'assertive');
                        t.setAttribute('aria-atomic', 'true');
                        t.style.maxWidth = '280px';
                        t.innerHTML = '<div class="d-flex"><div class="toast-body">' + (data.msg || 'Aluno removido.') + '</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Fechar"></button></div>';
                        container.appendChild(t);
                        if (typeof bootstrap !== 'undefined' && bootstrap.Toast) {
                            new bootstrap.Toast(t, { delay: 3000 }).show();
                            t.addEventListener('hidden.bs.toast', function () { t.remove(); });
                        } else {
                            setTimeout(function () { t.remove(); }, 3200);
                        }
                    } else {
                        btn.disabled = false;
                        alert(data.msg || 'Erro ao remover');
                    }
                  }).catch(function () { btn.disabled = false; alert('Erro ao remover'); });
            });
            div.appendChild(card);
            return div;
        }

        // Função para alternar entre modo normal e exceção
        window.alternarModoMatricula = function(modo) {
            modoMatriculaAtual = modo;
            var btnNormal = document.getElementById('btnModoNormal');
            var btnExcecao = document.getElementById('btnModoExcecao');
            var buscaExcecao = document.getElementById('buscaExcecao');
            var lista = document.getElementById('modalMatricularLista');
            var vazio = document.getElementById('modalMatricularVazio');
            var loading = document.getElementById('modalMatricularLoading');
            
            if (modo === 'normal') {
                btnNormal.classList.add('active');
                btnExcecao.classList.remove('active');
                buscaExcecao.style.display = 'none';
                lista.style.display = 'none';
                vazio.style.display = 'none';
                loading.style.display = 'block';
                // Recarregar alunos normais
                if (turmaIdAtual) {
                    carregarAlunosNormais(turmaIdAtual);
                }
            } else {
                btnNormal.classList.remove('active');
                btnExcecao.classList.add('active');
                buscaExcecao.style.display = 'block';
                lista.style.display = 'none';
                vazio.style.display = 'none';
                loading.style.display = 'none';
                document.getElementById('inputBuscaAluno').value = '';
            }
        };
        
        // Variável para controlar o timeout da busca dinâmica
        var timeoutBusca = null;
        
        // Função para buscar aluno por nome (modo exceção) - busca dinâmica
        window.buscarAlunoExcecao = function() {
            var nome = document.getElementById('inputBuscaAluno').value.trim();
            if (!turmaIdAtual) return;
            
            var lista = document.getElementById('modalMatricularLista');
            var vazio = document.getElementById('modalMatricularVazio');
            var loading = document.getElementById('modalMatricularLoading');
            
            // Se o nome tem menos de 2 caracteres, limpar resultados
            if (!nome || nome.length < 2) {
                lista.style.display = 'none';
                vazio.style.display = 'none';
                loading.style.display = 'none';
                lista.innerHTML = '';
                return;
            }
            
            loading.style.display = 'block';
            lista.style.display = 'none';
            vazio.style.display = 'none';
            
            fetch(urlBuscarAlunoExcecao.replace('999', turmaIdAtual) + '?nome=' + encodeURIComponent(nome))
                .then(function(r) {
                    return r.text().then(function(txt) {
                        var data;
                        try { data = JSON.parse(txt); } catch (e) { data = {}; }
                        if (!r.ok) throw new Error(data.error || 'HTTP ' + r.status);
                        return data;
                    });
                })
                .then(function(alunos) {
                    loading.style.display = 'none';
                    lista.innerHTML = '';
                    if (alunos.length === 0) {
                        vazio.innerHTML = '<i class="bi bi-person-x fs-1"></i><p class="mb-0">Nenhum aluno encontrado com esse nome.</p>';
                        vazio.style.display = 'block';
                        return;
                    }
                    lista.style.display = '';
                    alunos.forEach(function(a) {
                        var el = renderAlunoCard(a, function(aluno) {
                            if (!confirm('Matricular ' + (aluno.nome || 'este aluno') + ' nesta turma? (Exceção - sem verificação de idade)')) return;
                            matricularAlunoExcecao(turmaIdAtual, aluno.id, el, lista, vazio);
                        }, false);
                        lista.appendChild(el);
                    });
                })
                .catch(function(err) {
                    loading.style.display = 'none';
                    vazio.innerHTML = '<p class="text-danger">Erro ao buscar alunos: ' + (err.message || '') + '</p>';
                    vazio.style.display = 'block';
                });
        };
        
        // Função para carregar alunos normais
        function carregarAlunosNormais(turmaId) {
            fetch(urlAlunosDisponiveis.replace('999', turmaId))
                .then(function (r) {
                    return r.text().then(function (txt) {
                        var data;
                        try { data = JSON.parse(txt); } catch (e) { data = {}; }
                        if (!r.ok) throw new Error(data.error || 'HTTP ' + r.status);
                        return data;
                    });
                })
                .then(function (alunos) {
                    document.getElementById('modalMatricularLoading').style.display = 'none';
                    var lista = document.getElementById('modalMatricularLista');
                    lista.innerHTML = '';
                    if (alunos.length === 0) {
                        document.getElementById('modalMatricularVazio').style.display = 'block';
                        return;
                    }
                    document.getElementById('modalMatricularLista').style.display = '';
                    alunos.forEach(function (a) {
                        var el = renderAlunoCard(a, function (aluno) {
                            if (!confirm('Matricular ' + (aluno.nome || 'este aluno') + ' nesta turma?')) return;
                            matricularAlunoNormal(turmaId, aluno.id, el, lista);
                        }, false);
                        lista.appendChild(el);
                    });
                })
                .catch(function (err) {
                    document.getElementById('modalMatricularLoading').style.display = 'none';
                    document.getElementById('modalMatricularVazio').innerHTML = '<p class="text-danger">Erro ao carregar alunos: ' + (err.message || '') + '</p>';
                    document.getElementById('modalMatricularVazio').style.display = 'block';
                });
        }
        
        // Função para matricular aluno (modo normal)
        function matricularAlunoNormal(turmaId, alunoId, elemento, lista) {
            fetch(urlMatricularBase.replace('999', turmaId).replace('888', alunoId), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
                credentials: 'same-origin'
            }).then(function (res) { return res.json(); })
              .then(function (data) {
                if (data.ok) {
                    elemento.remove();
                    if (lista.children.length === 0) {
                        document.getElementById('modalMatricularLista').style.display = 'none';
                        document.getElementById('modalMatricularVazio').style.display = 'block';
                    }
                    mostrarToast(data.msg || 'Aluno matriculado!', 'success');
                } else {
                    alert(data.msg || 'Erro ao matricular');
                }
              }).catch(function () { alert('Erro ao matricular'); });
        }
        
        // Função para matricular aluno (modo exceção)
        function matricularAlunoExcecao(turmaId, alunoId, elemento, lista, vazio) {
            fetch(urlMatricularBase.replace('999', turmaId).replace('888', alunoId) + '?excecao=1', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
                credentials: 'same-origin'
            }).then(function (res) { return res.json(); })
              .then(function (data) {
                if (data.ok) {
                    elemento.remove();
                    if (lista.children.length === 0) {
                        lista.style.display = 'none';
                        vazio.innerHTML = '<i class="bi bi-person-x fs-1"></i><p class="mb-0">Nenhum aluno encontrado.</p>';
                        vazio.style.display = 'block';
                    }
                    mostrarToast(data.msg || 'Aluno matriculado com exceção!', 'success');
                } else {
                    alert(data.msg || 'Erro ao matricular');
                }
              }).catch(function () { alert('Erro ao matricular'); });
        }
        
        // Função auxiliar para mostrar toast
        function mostrarToast(mensagem, tipo) {
            var container = document.querySelector('.toast-container') || document.body;
            var t = document.createElement('div');
            t.className = 'toast align-items-center text-bg-' + (tipo || 'success') + ' border-0 mb-2';
            t.setAttribute('role', 'alert');
            t.setAttribute('aria-live', 'assertive');
            t.setAttribute('aria-atomic', 'true');
            t.style.maxWidth = '280px';
            t.innerHTML = '<div class="d-flex"><div class="toast-body">' + mensagem + '</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Fechar"></button></div>';
            container.appendChild(t);
            if (typeof bootstrap !== 'undefined' && bootstrap.Toast) {
                new bootstrap.Toast(t, { delay: 3000 }).show();
                t.addEventListener('hidden.bs.toast', function () { t.remove(); });
            } else {
                setTimeout(function () { t.remove(); }, 3200);
            }
        }
        
        // Busca dinâmica ao digitar (com debounce)
        document.addEventListener('DOMContentLoaded', function() {
            var inputBusca = document.getElementById('inputBuscaAluno');
            if (inputBusca) {
                // Busca dinâmica com debounce de 300ms
                inputBusca.addEventListener('input', function(e) {
                    // Limpar timeout anterior
                    if (timeoutBusca) {
                        clearTimeout(timeoutBusca);
                    }
                    
                    // Criar novo timeout para buscar após 300ms sem digitação
                    timeoutBusca = setTimeout(function() {
                        buscarAlunoExcecao();
                    }, 300);
                });
                
                // Também permitir buscar ao pressionar Enter (busca imediata)
                inputBusca.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        if (timeoutBusca) {
                            clearTimeout(timeoutBusca);
                        }
                        buscarAlunoExcecao();
                    }
                });
            }
        });
        
        matricularModal.addEventListener('shown.bs.modal', function (e) {
            var btn = e.relatedTarget;
            if (!btn) return;
            var turmaId = btn.getAttribute('data-turma-id');
            var turmaNome = btn.getAttribute('data-turma-nome');
            turmaIdAtual = turmaId;
            modoMatriculaAtual = 'normal';
            document.getElementById('modalMatricularTurmaNome').textContent = turmaNome;
            document.getElementById('modalMatricularLoading').style.display = 'block';
            document.getElementById('modalMatricularLista').style.display = 'none';
            document.getElementById('modalMatricularVazio').style.display = 'none';
            document.getElementById('modalMatricularVazio').innerHTML = '<i class="bi bi-person-x fs-1"></i><p class="mb-0">Nenhum aluno disponível (todos já matriculados ou fora da faixa etária).</p>';
            alternarModoMatricula('normal');

        });

        vinculadosModal.addEventListener('shown.bs.modal', function (e) {
            var btn = e.relatedTarget;
            if (!btn) return;
            var turmaId = btn.getAttribute('data-turma-id');
            var turmaNome = btn.getAttribute('data-turma-nome');
            document.getElementById('modalVinculadosTurmaNome').textContent = turmaNome;
            document.getElementById('modalVinculadosLoading').style.display = 'block';
            document.getElementById('modalVinculadosLista').style.display = 'none';
            document.getElementById('modalVinculadosVazio').style.display = 'none';
            document.getElementById('modalVinculadosVazio').innerHTML = '<i class="bi bi-person-x fs-1"></i><p class="mb-0">Nenhum aluno matriculado nesta turma.</p>';

            fetch(urlAlunosVinculados.replace('999', turmaId))
                .then(function (r) {
                    return r.text().then(function (txt) {
                        var data;
                        try { data = JSON.parse(txt); } catch (e) { data = {}; }
                        if (!r.ok) throw new Error(data.error || 'HTTP ' + r.status);
                        return data;
                    });
                })
                .then(function (alunos) {
                    document.getElementById('modalVinculadosLoading').style.display = 'none';
                    var lista = document.getElementById('modalVinculadosLista');
                    var vazio = document.getElementById('modalVinculadosVazio');
                    lista.innerHTML = '';
                    if (alunos.length === 0) {
                        vazio.style.display = 'block';
                        return;
                    }
                    document.getElementById('modalVinculadosLista').style.display = '';
                    alunos.forEach(function (a) {
                        lista.appendChild(renderAlunoCardComRemover(a, turmaId, function () {
                            if (lista.children.length === 0) {
                                lista.style.display = 'none';
                                vazio.style.display = 'block';
                            }
                        }));
                    });
                })
                .catch(function (err) {
                    document.getElementById('modalVinculadosLoading').style.display = 'none';
                    document.getElementById('modalVinculadosVazio').innerHTML = '<p class="text-danger">Erro ao carregar: ' + (err.message || '') + '</p>';
                    document.getElementById('modalVinculadosVazio').style.display = 'block';
                });
        });
    });
</script>
{% endblock %}