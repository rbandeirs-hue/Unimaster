{% extends "base.html" %}
{% block title %}Editar Turma{% endblock %}
{% block content %}
<style>
.turma-form-wrap { max-width: 680px; margin-left: auto; margin-right: auto; }
@media (min-width: 576px) { .turma-form-wrap { padding-left: 0.5rem; padding-right: 0.5rem; } }
.turma-form .form-section {
    border-left: 3px solid #cce5ff;
    background: linear-gradient(90deg, #f8fbff 0%, transparent 100%);
    padding: 1rem 1.25rem;
    margin-bottom: 1.25rem;
    border-radius: 0 8px 8px 0;
}
.turma-form .form-section h6 {
    color: #0d6efd;
    font-weight: 600;
    font-size: 0.9rem;
    margin-bottom: 0.85rem;
    letter-spacing: 0.02em;
}
.turma-form .auxiliar-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.5rem 0.75rem;
    border-radius: 8px;
    margin-bottom: 0.3rem;
    transition: background 0.2s;
}
.turma-form .auxiliar-row:hover { background: rgba(13, 110, 253, 0.06); }
.turma-form .auxiliar-row.d-none { display: none !important; }
.turma-form .card { border-radius: 14px; }
.turma-form .card-header { border-radius: 14px 14px 0 0; }
</style>
<div class="container py-4">
    <div class="turma-form-wrap mb-4">
        {% set back_url = back_url or get_back_url_default() %}
{% include 'components/botao_voltar.html' %}
        <h2 class="h4 fw-bold text-primary mb-1">Editar Turma</h2>
        <p class="text-muted small mb-0">{{ turma.Nome }} — {{ academia.nome if academia else '' }}</p>
    </div>

    <div class="card shadow-sm border-0 turma-form turma-form-wrap" style="border-radius: 14px; overflow: hidden;">
        <div class="card-header py-3" style="background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%); color: white; border: none;">
            <h5 class="mb-0 fw-bold"><i class="bi bi-pencil-square me-2"></i> Detalhes da Turma</h5>
        </div>
        <div class="card-body p-4">
            <form method="POST">
                <input type="hidden" name="next" value="{{ back_url }}">

                <div class="form-section">
                    <h6><i class="bi bi-tag me-1"></i> Informações básicas</h6>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="modalidade_id" class="form-label fw-semibold">Modalidade</label>
                            <select id="modalidade_id" name="modalidade_id" class="form-select">
                                <option value="">— Selecione (opcional) —</option>
                                {% for m in modalidades %}
                                <option value="{{ m.id }}" {% if turma_modalidade_id == m.id %}selected{% endif %}>{{ m.nome }}</option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">Apenas modalidades liberadas pela academia. Professores são filtrados pela modalidade.</small>
                        </div>
                        <div class="col-md-6">
                            <label for="nome" class="form-label fw-semibold">Nome da Turma <span class="text-danger">*</span></label>
                            <input type="text" id="nome" name="nome" class="form-control" required value="{{ turma.Nome }}">
                        </div>
                        <div class="col-12">
                            <label class="form-label fw-semibold">Dias da semana com aula <span class="text-danger">*</span></label>
                            <div class="d-flex flex-wrap gap-2">
                                {% for d in [('1','Seg'),('2','Ter'),('3','Qua'),('4','Qui'),('5','Sex'),('6','Sáb'),('0','Dom')] %}
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" name="dias_semana" value="{{ d[0] }}" id="dia_{{ d[0] }}"
                                        {% if turma.dias_semana and d[0] in (turma.dias_semana or '').split(',') %}checked{% endif %}>
                                    <label class="form-check-label" for="dia_{{ d[0] }}">{{ d[1] }}</label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="hora_inicio" class="form-label fw-semibold">Hora início do treino <span class="text-danger">*</span></label>
                            <input type="time" id="hora_inicio" name="hora_inicio" class="form-control" required
                                value="{{ hora_inicio_display or '' }}">
                        </div>
                        <div class="col-md-6">
                            <label for="hora_fim" class="form-label fw-semibold">Hora fim do treino <span class="text-danger">*</span></label>
                            <input type="time" id="hora_fim" name="hora_fim" class="form-control" required
                                value="{{ hora_fim_display or '' }}">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h6><i class="bi bi-people me-1"></i> Faixa etária e classificação</h6>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="idade_min" class="form-label fw-semibold">Idade Mín. <span class="text-danger">*</span></label>
                            <input type="number" id="idade_min" name="idade_min" class="form-control" required min="1" value="{{ turma.IdadeMin }}">
                        </div>
                        <div class="col-md-4">
                            <label for="idade_max" class="form-label fw-semibold">Idade Máx. <span class="text-danger">*</span></label>
                            <input type="number" id="idade_max" name="idade_max" class="form-control" required min="1" value="{{ turma.IdadeMax }}">
                        </div>
                        <div class="col-md-4">
                            <label for="classificacao" class="form-label fw-semibold">Classificação <span class="text-danger">*</span></label>
                            <input type="text" id="classificacao" name="classificacao" class="form-control" required value="{{ turma.Classificacao }}">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h6><i class="bi bi-person-badge me-1"></i> Professores</h6>
                    <div class="mb-3">
                        <label for="professor_responsavel_id" class="form-label fw-semibold">Professor responsável <span class="text-danger">*</span></label>
                        <select id="professor_responsavel_id" name="professor_responsavel_id" class="form-select" required>
                            <option value="">— Selecione —</option>
                            {% for prof in professores %}
                            <option value="{{ prof.id }}" data-modalidades="{{ (prof_modalidades.get(prof.id, []) | map('string') | list | join(',')) or '' }}" {% if prof.id == professor_responsavel_id %}selected{% endif %}>{{ prof.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <label class="form-label fw-semibold">Professores auxiliares</label>
                    <div class="border rounded p-3" style="max-height: 200px; overflow-y: auto; background: #f8fafc;">
                        {% for prof in professores %}
                        <div class="auxiliar-row" data-prof-id="{{ prof.id }}" data-modalidades="{{ (prof_modalidades.get(prof.id, []) | map('string') | list | join(',')) or '' }}">
                            <span class="text-dark">{{ prof.nome }}</span>
                            <div class="form-check form-switch mb-0">
                                <input class="form-check-input" type="checkbox" name="professor_auxiliar_ids" value="{{ prof.id }}" id="aux_{{ prof.id }}" {% if prof.id in professor_auxiliar_ids %}checked{% endif %}>
                                <label class="form-check-label small text-muted" for="aux_{{ prof.id }}">Auxiliar</label>
                            </div>
                        </div>
                        {% endfor %}
                        {% if not professores %}
                        <p class="text-muted small mb-0">Nenhum professor cadastrado.</p>
                        {% endif %}
                    </div>
                    <small class="text-muted">Ative o switch para adicionar como auxiliar. O responsável não aparece na lista.</small>
                </div>

                <div class="form-section">
                    <h6><i class="bi bi-gear me-1"></i> Configurações</h6>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="capacidade" class="form-label fw-semibold">Capacidade máxima</label>
                            <input type="number" id="capacidade" name="capacidade" class="form-control" required min="1" value="{{ turma.Capacidade }}">
                        </div>
                        <div class="col-md-6">
                            <label for="id_academia" class="form-label fw-semibold">Academia <span class="text-danger">*</span></label>
                            {% if academias %}
                            <select id="id_academia" name="id_academia" class="form-select" required>
                                <option value="" disabled {% if not academia_selecionada %}selected{% endif %}>Selecione</option>
                                {% for academia in academias %}
                                <option value="{{ academia.id }}" {% if academia.id == academia_selecionada %}selected{% endif %}>{{ academia.nome }}</option>
                                {% endfor %}
                            </select>
                            {% else %}
                            <div class="alert alert-warning py-2 mb-0">Nenhuma academia disponível.</div>
                            {% endif %}
                        </div>
                        <div class="col-12">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" name="controla_limite" id="controla_limite" value="1" {% if turma.controla_limite %}checked{% endif %}>
                                <label class="form-check-label" for="controla_limite">Controlar limite de vagas</label>
                            </div>
                            <small class="text-muted">Bloqueia novas matrículas ao atingir a capacidade.</small>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h6><i class="bi bi-chat-text me-1"></i> Observações</h6>
                    <textarea id="observacoes" name="observacoes" class="form-control" rows="2" placeholder="Informações adicionais sobre a turma...">{{ turma.Observacoes or '' }}</textarea>
                </div>

                <div class="d-flex justify-content-end gap-2 pt-3 border-top mt-4">
                    <a href="{{ back_url }}" class="btn btn-outline-secondary">Cancelar</a>
                    <button type="submit" class="btn btn-primary px-4"><i class="bi bi-check-lg me-1"></i> Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>
</div>
<script>
(function() {
    var selProf = document.getElementById('professor_responsavel_id');
    var selMod = document.getElementById('modalidade_id');
    var rows = document.querySelectorAll('.auxiliar-row[data-prof-id]');

    function professorCompativel(elem) {
        var modSel = selMod ? selMod.value : '';
        if (!modSel) return true;
        var mods = (elem.dataset.modalidades || '').split(',').filter(Boolean);
        return mods.indexOf(modSel) >= 0;
    }

    function filtrarPorModalidade() {
        if (selProf) {
            [].slice.call(selProf.options).forEach(function(opt) {
                if (!opt.value) { opt.style.display = ''; return; }
                opt.style.display = professorCompativel(opt) ? '' : 'none';
            });
            var selVal = selProf.value;
            var optSel = selProf.querySelector('option[value="' + selVal + '"]');
            if (optSel && optSel.style.display === 'none') {
                selProf.value = '';
            }
        }
    }

    function atualizarAuxiliares() {
        var rid = selProf ? selProf.value : '';
        rows.forEach(function(r) {
            var ehResponsavel = r.dataset.profId === rid;
            var semModalidade = !professorCompativel(r);
            var ocultar = ehResponsavel || semModalidade;
            r.classList.toggle('d-none', ocultar);
            if (ocultar) {
                var cb = r.querySelector('input[type="checkbox"]');
                if (cb) cb.checked = false;
            }
        });
    }

    if (selMod) selMod.addEventListener('change', function() { filtrarPorModalidade(); atualizarAuxiliares(); });
    if (selProf) selProf.addEventListener('change', atualizarAuxiliares);
    filtrarPorModalidade();
    atualizarAuxiliares();
})();
</script>
{% endblock %}
