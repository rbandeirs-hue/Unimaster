<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% block title %}Judo Academy{% endblock %}</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

  <link rel="stylesheet" href="{{ url_for('static', filename='css/base/layout.css') }}">
  {% block extra_css %}{% endblock %}
</head>

<body>

{% if current_user.is_authenticated %}

<!-- ====================================================== -->
<!-- üîπ SIDEBAR COM RBAC REAL                               -->
<!-- ====================================================== -->
<div class="sidebar" id="sidebar">

  <div class="brand d-flex align-items-center gap-2 px-3">
    {% if contexto_logo_url %}
    <img src="{{ contexto_logo_url }}" alt="Logo" class="brand-logo" style="width: 40px; height: 40px; object-fit: contain; border-radius: 6px; background: rgba(255,255,255,0.2);">
    {% else %}
    <i class="bi bi-trophy-fill fs-4"></i>
    {% endif %}
    <strong class="brand-text text-truncate">{{ contexto_nome or 'Judo Academy' }}</strong>
  </div>

  <nav class="nav flex-column mt-3">
    <!-- üë§ Menu mobile: usu√°rio e modo (vis√≠vel s√≥ em telas pequenas, exceto aluno) -->
    {% if not current_user.has_role('aluno') %}
    <div class="sidebar-mobile-user d-lg-none border-bottom border-secondary mb-2 pb-2">
      <div class="px-3 py-2">
        <a class="nav-link d-flex align-items-center gap-2" href="{{ url_for('usuarios.meu_perfil', next=request.url) }}">
          <i class="bi bi-person-circle fs-4"></i>
          <div class="text-start">
            <span class="small fw-bold d-block">{{ current_user.nome }}</span>
            <span class="small opacity-75">{{ modo_atual_nome() }}</span>
          </div>
        </a>
        <div class="d-flex flex-column gap-1 mt-2">
          <a class="nav-link py-2 small" href="{{ url_for('usuarios.meu_perfil', next=request.url) }}">
            <i class="bi bi-person-lines-fill me-2"></i> Editar cadastro
          </a>
          {% if tem_multiplos_modos() %}
          <div class="dropdown mt-1">
            <a class="nav-link py-2 small dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
              <i class="bi bi-arrow-repeat me-2"></i> Trocar modo
            </a>
            <ul class="dropdown-menu dropdown-menu-dark">
              {% for modo_id, modo_nome in modos_disponiveis() %}
              <li><a class="dropdown-item" href="{{ url_for('painel.escolher_modo', modo=modo_id) }}">{{ modo_nome }}</a></li>
              {% endfor %}
            </ul>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
    {% endif %}

    <!-- üîπ Painel/Dash ‚Äî aluno e academia t√™m Dash pr√≥prio -->
    <a class="nav-link {% if request.endpoint == 'painel.home' or request.endpoint == 'painel.escolher_modo' or (session.get('modo_painel') == 'aluno' and request.endpoint == 'painel_aluno.painel') or (session.get('modo_painel') == 'academia' and request.endpoint == 'academia.dash') %}active{% endif %}"
       href="{{ url_for('painel_aluno.painel') if session.get('modo_painel') == 'aluno' else (url_for('academia.dash') if session.get('modo_painel') == 'academia' else url_for('painel.home')) }}">
      <i class="bi bi-speedometer2"></i> {{ 'Dash' if session.get('modo_painel') in ('aluno', 'academia') else 'Painel' }}
    </a>

    <!-- ====================================================== -->
    <!-- Menus por modo: s√≥ exibe o menu do modo acessado        -->
    <!-- ====================================================== -->
    <!-- üëë MODO ADMIN -->
    {% if session.get('modo_painel') == 'admin' and current_user.has_role('admin') %}
      <a class="nav-link" href="{{ url_for('federacao.painel_federacao') }}">
        <i class="bi bi-diagram-3"></i> Associa√ß√µes
      </a>
      <a class="nav-link" href="{{ url_for('associacao.painel_associacao') }}">
        <i class="bi bi-people"></i> Academias
      </a>
      <a class="nav-link" href="{{ url_for('alunos.lista_alunos') }}">
        <i class="bi bi-people-fill"></i> Alunos
      </a>
      <a class="nav-link" href="{{ url_for('cadastros.hub') }}">
        <i class="bi bi-person-lines-fill"></i> Cadastros
      </a>
      <a class="nav-link" href="{{ url_for('academia.painel_academia') }}"><i class="bi bi-gear"></i> Gerenciamento</a>
      <a class="nav-link" href="{{ url_for('financeiro.dashboard') }}"><i class="bi bi-cash-coin"></i> Financeiro</a>
      <a class="nav-link" href="{{ url_for('configuracoes.hub') }}"><i class="bi bi-sliders"></i> Configura√ß√µes</a>
    {% endif %}

    <!-- üü¶ MODO FEDERA√á√ÉO -->
    {% if session.get('modo_painel') == 'federacao' and current_user.has_role('gestor_federacao') %}
      <a class="nav-link" href="{{ url_for('federacao.painel_federacao') }}">
        <i class="bi bi-diagram-3"></i> Associa√ß√µes
      </a>
      <a class="nav-link" href="{{ url_for('alunos.lista_alunos') }}">
        <i class="bi bi-people-fill"></i> Alunos
      </a>
      <a class="nav-link" href="{{ url_for('financeiro.dashboard') }}"><i class="bi bi-cash-coin"></i> Financeiro</a>
    {% endif %}

    <!-- üü© MODO ASSOCIA√á√ÉO -->
    {% if session.get('modo_painel') == 'associacao' and current_user.has_role('gestor_associacao') %}
      <a class="nav-link" href="{{ url_for('associacao.painel_associacao') }}">
        <i class="bi bi-people"></i> Academias
      </a>
      <a class="nav-link" href="{{ url_for('alunos.lista_alunos') }}">
        <i class="bi bi-people-fill"></i> Alunos
      </a>
      <a class="nav-link" href="{{ url_for('financeiro.dashboard') }}"><i class="bi bi-cash-coin"></i> Financeiro</a>
    {% endif %}

    <!-- üüß MODO ACADEMIA -->
    {% if session.get('modo_painel') == 'academia' %}
      <a class="nav-link {% if request.endpoint == 'academia.painel_academia' %}active{% endif %}" href="{{ url_for('academia.painel_academia') }}">
        <i class="bi bi-gear"></i> Gerenciamento
      </a>
    {% endif %}

    <!-- ====================================================== -->
    <!-- üü° MODO ALUNO ‚Äî MEU PERFIL (Painel j√° no menu geral)   -->
    <!-- ====================================================== -->
    {% if session.get('modo_painel') == 'aluno' %}
      <a class="nav-link {% if request.endpoint == 'painel_aluno.meu_perfil' %}active{% endif %}" href="{{ url_for('painel_aluno.meu_perfil') }}">
        <i class="bi bi-person-badge"></i> Meu Perfil
      </a>
    {% endif %}

  </nav>

  <div class="logout mt-auto mb-3">
    <a class="nav-link text-danger fw-bold" href="{{ url_for('auth.logout') }}">
      <i class="bi bi-box-arrow-right"></i> Sair
    </a>
  </div>

</div>
<button type="button" class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()" aria-label="Fechar menu"></button>
{% endif %}



<!-- ====================================================== -->
<!-- üîπ MAIN CONTENT                                         -->
<!-- ====================================================== -->
<div class="main-content" id="main-content">

  {% if current_user.is_authenticated %}
  <div class="navbar-top">
    <button class="toggle-btn" onclick="toggleSidebar()" aria-label="Abrir menu">
      <i class="bi bi-list"></i>
    </button>
    <div class="dropdown d-lg-none ms-auto">
      <button class="toggle-btn toggle-btn-user dropdown-toggle" type="button" id="dropdownUsuarioMobile" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Conta e configura√ß√µes">
        <i class="bi bi-person-circle"></i>
      </button>
      <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownUsuarioMobile">
        <li><h6 class="dropdown-header">Configura√ß√µes de usu√°rio</h6></li>
        <li>
          <a class="dropdown-item" href="{{ url_for('usuarios.meu_perfil', next=request.url) }}">
            <i class="bi bi-person-lines-fill me-2"></i> Editar cadastro
          </a>
        </li>
        {% if tem_multiplos_modos() %}
        <li><hr class="dropdown-divider"></li>
        <li><h6 class="dropdown-header">Trocar modo</h6></li>
        {% for modo_id, modo_nome in modos_disponiveis() %}
        <li>
          <a class="dropdown-item" href="{{ url_for('painel.escolher_modo', modo=modo_id) }}">
            {{ modo_nome }}
          </a>
        </li>
        {% endfor %}
        {% endif %}
      </ul>
    </div>

    <div class="user-info ms-auto d-none d-lg-flex align-items-center gap-2">
      <div class="dropdown">
        <button class="btn btn-link p-0 text-dark text-decoration-none dropdown-toggle d-flex align-items-center" type="button" id="dropdownUsuario" data-bs-toggle="dropdown" aria-expanded="false" style="line-height: 1.2;">
          <div class="text-start">
            <strong>{{ current_user.nome }}</strong><br>
            <small class="text-muted d-block text-end">{{ modo_atual_nome() }}</small>
          </div>
        </button>
        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownUsuario">
          <li><h6 class="dropdown-header">Configura√ß√µes de usu√°rio</h6></li>
          <li>
            <a class="dropdown-item" href="{{ url_for('usuarios.meu_perfil', next=request.url) }}">
              <i class="bi bi-person-lines-fill me-2"></i> Editar cadastro
            </a>
          </li>
          {% if tem_multiplos_modos() %}
          <li><hr class="dropdown-divider"></li>
          <li><h6 class="dropdown-header">Trocar modo</h6></li>
          {% for modo_id, modo_nome in modos_disponiveis() %}
          <li>
            <a class="dropdown-item" href="{{ url_for('painel.escolher_modo', modo=modo_id) }}">
              {{ modo_nome }}
            </a>
          </li>
          {% endfor %}
          {% endif %}
        </ul>
      </div>
    </div>
  </div>
  {% endif %}

  {% with messages = get_flashed_messages(with_categories=True) %}
    {% if messages %}
    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100;">
      {% for category, message in messages %}
        {% set cat = category or 'info' %}
        {% set bg = 'text-bg-info' %}
        {% if cat == 'success' %}
          {% set bg = 'text-bg-success' %}
        {% elif cat == 'danger' %}
          {% set bg = 'text-bg-danger' %}
        {% elif cat == 'warning' %}
          {% set bg = 'text-bg-warning' %}
        {% elif cat == 'info' %}
          {% set bg = 'text-bg-info' %}
        {% endif %}
        <div class="toast align-items-center {{ bg }} border-0 mb-2" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="5000">
          <div class="d-flex">
            <div class="toast-body">
              {{ message }}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Fechar"></button>
          </div>
        </div>
      {% endfor %}
    </div>
    {% endif %}
  {% endwith %}

  <div class="container-fluid mt-4">
    {% block content %}{% endblock %}
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
function toggleSidebar() {
    const sidebar = document.getElementById("sidebar");
    const main = document.getElementById("main-content");
    const overlay = document.getElementById("sidebar-overlay");

    sidebar.classList.toggle("active");
    main.classList.toggle("sidebar-active");
    if (overlay) overlay.classList.toggle("show");
}

document.addEventListener("DOMContentLoaded", () => {
    const toastElList = document.querySelectorAll(".toast");
    toastElList.forEach((toastEl) => {
        const toast = new bootstrap.Toast(toastEl);
        toast.show();
    });
});
</script>

{% block extra_js %}{% endblock %}
</body>
</html>
