{% extends "base.html" %}
{% block title %}Hist칩rico de Presen칞a{% endblock %}
{% block content %}
<style>
    .historico-card-mini {
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        transition: box-shadow 0.2s, border-color 0.2s;
    }
    .historico-card-mini:hover { border-color: var(--bs-primary); box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    .historico-card-mini .btn-toggle {
        padding: 0.5rem 0.75rem;
        font-size: 0.9rem;
        text-align: left;
        background: #f8f9fa;
        border: none;
        border-radius: 0.5rem;
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    .historico-card-mini .btn-toggle:hover { background: #e9ecef; }
    .historico-card-mini .btn-toggle.collapsed .bi-chevron-down { transform: rotate(-90deg); }
    .historico-card-mini .btn-toggle .bi-chevron-down { transition: transform 0.2s; }
    .historico-card-mini .collapse-body { padding: 0.75rem; background: #fff; border-top: 1px solid #eee; font-size: 0.85rem; }
    @media (max-width: 767px) {
        .historico-card-mini .btn-toggle { padding: 0.4rem 0.6rem; font-size: 0.85rem; }
        .historico-card-mini .collapse-body { padding: 0.5rem; }
    }
</style>

<div class="container mt-4">
    <h2 class="mb-4 text-center text-primary fw-bold">游 Hist칩rico de Presen칞a</h2>
    <a href="{{ back_url or url_for('presencas.painel_presenca') }}" class="btn btn-secondary mb-3 shadow-sm">
        <i class="bi bi-arrow-left"></i> Voltar
    </a>

    {% set meses = ["Todos os meses","Janeiro","Fevereiro","Mar칞o","Abril","Maio","Junho",
                    "Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"] %}
    <div class="d-flex flex-wrap gap-2 align-items-center mb-3 p-3 bg-light rounded">
        <label class="form-label mb-0 small fw-semibold">Filtrar:</label>
        <select id="filtro-mes" class="form-select form-select-sm" style="max-width:140px;">
            {% for i in range(0,13) %}
            <option value="{{ i }}" {% if i == hoje.month %}selected{% endif %}>{{ meses[i] }}</option>
            {% endfor %}
        </select>
        <input type="number" id="filtro-ano" class="form-control form-control-sm" style="max-width:90px;" min="2000" max="2100" value="{{ hoje.year }}">
    </div>

    <div class="row g-2" id="accordionHistorico">
        {% for aluno in alunos %}
            {% set collapse_id = "collapse_" ~ aluno.id %}
            
            <div class="col-12 col-md-4 col-lg-3">
                <div class="historico-card-mini">
                    <button class="btn-toggle collapsed" type="button" data-bs-toggle="collapse"
                            data-bs-target="#{{ collapse_id }}" aria-expanded="false" aria-controls="{{ collapse_id }}">
                        <span class="text-truncate"><i class="bi bi-person-circle me-1 small"></i>{{ aluno.nome }}</span>
                        <i class="bi bi-chevron-down small"></i>
                    </button>
                    <div id="{{ collapse_id }}" class="collapse">
                        <div class="collapse-body">
                            <div class="historico-conteudo" id="historico-{{ aluno.id }}">
                                <div class="text-center text-muted small py-2">
                                    <i class="bi bi-arrow-down-circle me-1"></i> Abra para carregar.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {

    // --- CORRE칂츾O DO ERRO 'ALUNO_ID' ---
    // 1. Usamos um ID num칠rico dummy (e.g., 9999999) para satisfazer o <int:aluno_id> do Flask.
    {% set DUMMY_ID = 999999999 %}
    const templatePath = "{{ url_for('presencas.historico_presenca_ajax', aluno_id=DUMMY_ID) }}";

    // 2. No JavaScript, substitu칤mos o ID dummy pelo nosso placeholder de string 'ALUNO_ID'.
    // Isso cria um template de URL seguro para uso em JS.
    const baseAjaxUrl = templatePath.replace('{{ DUMMY_ID }}', 'ALUNO_ID');
    // ------------------------------------

    function carregarHistorico(alunoId, mes, ano, targetDiv) {
        // Exibe um loading
        targetDiv.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';

        // 1. Substitui o placeholder 'ALUNO_ID' pelo ID real do aluno
        const urlWithId = baseAjaxUrl.replace('ALUNO_ID', alunoId);
        
        // 2. Adiciona os par칙metros de consulta (mes, ano e academia_id)
        let finalUrl = `${urlWithId}?mes=${encodeURIComponent(mes)}&ano=${encodeURIComponent(ano)}`;
        {% if academia_id %}finalUrl += '&academia_id={{ academia_id }}';{% endif %}
        
        // 3. Realiza o fetch
        fetch(finalUrl)
            .then(resp => {
                if (!resp.ok) {
                    throw new Error(`Erro de rede: ${resp.status}`);
                }
                return resp.text();
            })
            .then(html => targetDiv.innerHTML = html)
            .catch(err => {
                targetDiv.innerHTML = `<p class="alert alert-danger p-2 small"><i class="bi bi-exclamation-triangle-fill"></i> Erro ao carregar hist칩rico: ${err.message}.</p>`;
                console.error("Erro ao carregar hist칩rico:", err);
            });
    }

    function getFiltros() {
        return {
            mes: document.getElementById('filtro-mes').value,
            ano: document.getElementById('filtro-ano').value
        };
    }

    function recarregarCardsAbertos() {
        document.querySelectorAll('.collapse.show').forEach(collapse => {
            if (!collapse.id || !collapse.id.startsWith('collapse_')) return;
            const alunoId = collapse.id.replace('collapse_', '');
            const { mes, ano } = getFiltros();
            const target = collapse.querySelector('.historico-conteudo');
            if (target) carregarHistorico(alunoId, mes, ano, target);
        });
    }

    document.querySelectorAll('.collapse').forEach(collapse => {
        if (!collapse.id || !collapse.id.startsWith('collapse_')) return;
        collapse.addEventListener('show.bs.collapse', function() {
            const alunoId = this.id.replace('collapse_', '');
            const { mes, ano } = getFiltros();
            const target = this.querySelector('.historico-conteudo');
            carregarHistorico(alunoId, mes, ano, target);
        });
    });

    document.getElementById('filtro-mes').addEventListener('change', recarregarCardsAbertos);
    document.getElementById('filtro-ano').addEventListener('change', recarregarCardsAbertos);

});
</script>
{% endblock %}