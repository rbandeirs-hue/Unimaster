{% extends "base.html" %}
{% block content %}
<style>
.registro-aluno-card { cursor: pointer; transition: background 0.2s, border-color 0.2s; }
.registro-aluno-card:hover { background: #fff9e6; border-color: #ffc107 !important; }
.registro-aluno-card:has(input:checked) { background: #fff3cd; border-color: #ffc107 !important; }
.registro-aluno-foto { width: 56px; height: 56px; object-fit: cover; border: 2px solid #e9ecef; }
.registro-aluno-foto-placeholder { background: #f8f9fa; font-size: 1.5rem; }
.registro-aluno-nome { word-break: break-word; line-height: 1.2; }
.registro-aluno-card .form-check-input { margin-top: 0.25rem; flex-shrink: 0; }
</style>
<div class="row justify-content-center">
  <div class="col-md-8 col-sm-12">

    <!-- Botão Voltar -->
    {% set back_url = back_url or get_back_url_default() %}
{% include 'components/botao_voltar.html' %}

    <div class="card shadow">
      <div class="card-header bg-warning text-dark">
        <h4 class="mb-0">Registro de Presença</h4>
      </div>
      <div class="card-body">

        <!-- Seleção de Turma e Data -->
        <form method="get" class="mb-3 row g-3">
          {% if academia_id %}<input type="hidden" name="academia_id" value="{{ academia_id }}">{% endif %}
          <div class="col-md-6">
            <label for="turma_id" class="form-label">Selecionar Turma</label>
            <select name="turma_id" id="turma_id" class="form-select" onchange="this.form.submit()">
              <option value="">-- Escolha a turma --</option>
              {% for turma in turmas %}
                <option value="{{ turma.TurmaID }}" {% if turma_selecionada == turma.TurmaID %}selected{% endif %}>
                  {{ turma.Nome }}
                </option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-6">
            <label for="data_presenca" class="form-label">Data da Aula</label>
            <input type="date" class="form-control" name="data_presenca" id="data_presenca"
                   value="{{ data_presenca }}" onchange="this.form.submit()">
          </div>
        </form>

        {% if alunos %}
        <!-- Lista de Alunos -->
        <form method="POST">
          {% if academia_id %}<input type="hidden" name="academia_id" value="{{ academia_id }}">{% endif %}
          <input type="hidden" name="turma_id" value="{{ turma_selecionada }}">
          <input type="hidden" name="data_presenca" value="{{ data_presenca }}">

          <div class="mb-3">
            <label class="form-label">Selecione os alunos presentes:</label>
            <div class="row g-3">
              {% for aluno in alunos %}
              <div class="col-6 col-md-4 col-lg-3">
                <label class="registro-aluno-card form-check position-relative d-flex flex-column align-items-center text-center p-3 border rounded-3 mb-0 h-100 {% if aluno.bloqueado %}opacity-75{% endif %}" 
                       for="aluno{{ aluno.id }}" {% if aluno.bloqueado %}style="cursor: not-allowed;"{% endif %}>
                  <input class="form-check-input position-absolute top-0 end-0 m-2" type="checkbox" name="aluno_id"
                         value="{{ aluno.id }}" id="aluno{{ aluno.id }}"
                         {% if aluno.bloqueado %}disabled{% endif %}
                         {% if aluno.id in presencas_registradas %}checked{% endif %}>
                  {% if aluno.foto %}
                  <img src="{{ url_for('static', filename='uploads/' + aluno.foto) }}" alt="" class="registro-aluno-foto rounded-circle mb-2">
                  {% else %}
                  <div class="registro-aluno-foto registro-aluno-foto-placeholder rounded-circle mb-2 d-flex align-items-center justify-content-center">
                    <i class="bi bi-person-fill text-secondary"></i>
                  </div>
                  {% endif %}
                  <span class="registro-aluno-nome small fw-semibold">{{ aluno.nome }}</span>
                  {% if aluno.visitante %}<span class="badge bg-info mt-1">Visitante</span>{% elif aluno.aluno_visita %}<span class="badge bg-warning mt-1">Aluno em Visita</span>{% endif %}
                  {% if aluno.aluno_visita and aluno.academia_origem_nome %}<div class="small text-muted mt-1"><i class="bi bi-building me-1"></i>{{ aluno.academia_origem_nome }}</div>{% endif %}
                  {% if aluno.visitando_outra_academia %}
                  <span class="badge bg-secondary mt-1">Visitando</span>
                  {% if aluno.academia_destino_nome %}<div class="small text-muted mt-1"><i class="bi bi-building me-1"></i>{{ aluno.academia_destino_nome }}</div>{% endif %}
                  {% endif %}
                </label>
              </div>
              {% endfor %}
            </div>
          </div>

          <button type="submit" class="btn btn-warning w-100">Registrar Presença</button>
        </form>
        {% else %}
          {% if turma_selecionada %}
            <p class="text-center">Nenhum aluno encontrado para esta turma.</p>
          {% endif %}
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}
