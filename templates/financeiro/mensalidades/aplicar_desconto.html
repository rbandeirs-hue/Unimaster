{% extends "base.html" %}
{% block title %}Aplicar Desconto{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/financeiro/responsive.css') }}?v=2">
{% endblock %}
{% block content %}
<div class="container mt-4 aplicar-desconto-page">
    {% if academias and academias|length > 1 %}
    <form method="GET" class="mb-3">
        <label class="form-label small fw-semibold">Academia:</label>
        <select name="academia_id" class="form-select form-select-sm d-inline-block w-auto" onchange="this.form.submit()">
            {% for ac in academias %}
            <option value="{{ ac.id }}" {% if ac.id == academia_id %}selected{% endif %}>{{ ac.nome }}</option>
            {% endfor %}
        </select>
    </form>
    {% endif %}
    {% set back_url = url_for('financeiro.mensalidades_alunos', academia_id=academia_id) if academia_id else url_for('financeiro.mensalidades_alunos') %}
    {% include 'components/botao_voltar.html' %}
    <h2 class="h4 fw-bold mb-3">Aplicar Desconto</h2>
    <p class="text-muted mb-4">Busque o aluno, selecione o desconto e o período de vigência. As mensalidades existentes no período serão atualizadas. Desconto 100% marca como pago. Você pode cancelar o desconto depois.</p>

    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-light">
            <h6 class="mb-0 fw-bold"><i class="bi bi-plus-circle me-2"></i> Aplicar desconto</h6>
        </div>
        <div class="card-body">
            <form method="POST" id="form-aplicar">
                <input type="hidden" name="acao" value="aplicar">
                <input type="hidden" name="aluno_id" id="aluno_id" value="">
                <div class="row g-3">
                    <div class="col-12">
                        <label class="form-label fw-semibold">Buscar aluno <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="busca_aluno" placeholder="Digite o nome do aluno..." autocomplete="off">
                        <div id="lista_alunos" class="border rounded mt-2 aplicar-desconto-lista-alunos" style="max-height: 220px; overflow-y: auto; display: none; background: var(--bs-body-bg);">
                        </div>
                        <div id="aluno_selecionado" class="mt-2 d-none">
                            <span class="badge bg-success fs-6" id="nome_aluno_sel"></span>
                            <button type="button" class="btn btn-sm btn-outline-secondary ms-2" id="limpar_aluno">Alterar</button>
                        </div>
                    </div>
                    <div class="col-12 col-md-4">
                        <label class="form-label fw-semibold">Desconto <span class="text-danger">*</span></label>
                        <select name="desconto_id" class="form-select" required>
                            <option value="">Selecione...</option>
                            {% for d in descontos %}
                            <option value="{{ d.id }}">{{ d.nome }} — {% if d.tipo == 'percentual' %}{{ "%.0f"|format(d.valor|float) }}%{% else %}R$ {{ "%.2f"|format(d.valor|float) }}{% endif %}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-6 col-md-2">
                        <label class="form-label fw-semibold">Início vigência</label>
                        <input type="date" name="data_inicio" class="form-control" id="data_inicio">
                    </div>
                    <div class="col-6 col-md-2">
                        <label class="form-label fw-semibold">Fim vigência</label>
                        <input type="date" name="data_fim" class="form-control" id="data_fim">
                    </div>
                    <div class="col-12 col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100">Aplicar</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="card border-0 shadow-sm">
        <div class="card-header bg-light">
            <h6 class="mb-0 fw-bold"><i class="bi bi-list me-2"></i> Descontos ativos</h6>
        </div>
        <div class="card-body p-0">
            {% if vinculos %}
            <div class="table-responsive d-none d-md-block">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Aluno</th>
                            <th>Desconto</th>
                            <th>Vigência</th>
                            <th class="text-end">Ação</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for v in vinculos %}
                        <tr>
                            <td class="fw-semibold">{{ v.aluno_nome }}</td>
                            <td>
                                {{ v.desconto_nome }}
                                {% if v.desconto_tipo == 'percentual' %}
                                <span class="badge bg-secondary">{{ "%.0f"|format(v.desconto_valor|float) }}%</span>
                                {% else %}
                                <span class="badge bg-secondary">R$ {{ "%.2f"|format(v.desconto_valor|float) }}</span>
                                {% endif %}
                            </td>
                            <td>{{ v.data_inicio|data_br or '-' }} até {{ v.data_fim|data_br or '-' }}</td>
                            <td class="text-end">
                                <button type="button" class="btn btn-sm btn-outline-primary me-1" data-bs-toggle="modal" data-bs-target="#modalEditar{{ v.id }}">
                                    <i class="bi bi-pencil"></i> Editar
                                </button>
                                <form method="POST" class="d-inline" onsubmit="return confirm('Cancelar este desconto? As mensalidades não pagas voltarão ao valor normal; as marcadas como paga por desconto 100% voltarão para pendente.');">
                                    <input type="hidden" name="acao" value="cancelar">
                                    <input type="hidden" name="aluno_id" value="{{ v.aluno_id }}">
                                    <input type="hidden" name="desconto_id" value="{{ v.desconto_id }}">
                                    <button type="submit" class="btn btn-sm btn-outline-danger">Cancelar</button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="d-md-none aplicar-desconto-mobile-cards">
                {% for v in vinculos %}
                <div class="card border-0 border-bottom rounded-0">
                    <div class="card-body p-3">
                        <p class="mb-1 fw-bold">{{ v.aluno_nome }}</p>
                        <p class="mb-1 small text-muted">
                            {{ v.desconto_nome }}
                            {% if v.desconto_tipo == 'percentual' %}
                            <span class="badge bg-secondary">{{ "%.0f"|format(v.desconto_valor|float) }}%</span>
                            {% else %}
                            <span class="badge bg-secondary">R$ {{ "%.2f"|format(v.desconto_valor|float) }}</span>
                            {% endif %}
                        </p>
                        <p class="mb-2 small">{{ v.data_inicio|data_br or '-' }} até {{ v.data_fim|data_br or '-' }}</p>
                        <div class="d-flex flex-column gap-1">
                            <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#modalEditar{{ v.id }}">
                                <i class="bi bi-pencil"></i> Editar
                            </button>
                            <form method="POST" onsubmit="return confirm('Cancelar este desconto?');">
                                <input type="hidden" name="acao" value="cancelar">
                                <input type="hidden" name="aluno_id" value="{{ v.aluno_id }}">
                                <input type="hidden" name="desconto_id" value="{{ v.desconto_id }}">
                                <button type="submit" class="btn btn-sm btn-outline-danger w-100">Cancelar</button>
                            </form>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="p-4 text-center text-muted">
                <i class="bi bi-percent fs-1"></i>
                <p class="mb-0">Nenhum desconto ativo no momento.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

{# Modais Editar #}
{% for v in vinculos %}
<div class="modal fade" id="modalEditar{{ v.id }}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST">
                <input type="hidden" name="acao" value="editar">
                <input type="hidden" name="aluno_desconto_id" value="{{ v.id }}">
                <input type="hidden" name="aluno_id" value="{{ v.aluno_id }}">
                <input type="hidden" name="desconto_id" value="{{ v.desconto_id }}">
                <div class="modal-header">
                    <h5 class="modal-title">Editar desconto — {{ v.aluno_nome }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Desconto</label>
                        <select name="novo_desconto_id" class="form-select" required>
                            {% for d in descontos %}
                            <option value="{{ d.id }}" {% if d.id == v.desconto_id %}selected{% endif %}>{{ d.nome }} — {% if d.tipo == 'percentual' %}{{ "%.0f"|format(d.valor|float) }}%{% else %}R$ {{ "%.2f"|format(d.valor|float) }}{% endif %}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Início vigência</label>
                        <input type="date" name="data_inicio" class="form-control" value="{{ (v.data_inicio|string)[:10] if v.data_inicio else '' }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Fim vigência</label>
                        <input type="date" name="data_fim" class="form-control" value="{{ (v.data_fim|string)[:10] if v.data_fim else '' }}">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}

<script>
(function() {
    const academiaId = "{{ academia_id or '' }}";
    const buscaInput = document.getElementById('busca_aluno');
    const listaAlunos = document.getElementById('lista_alunos');
    const alunoIdInput = document.getElementById('aluno_id');
    const alunoSelecionado = document.getElementById('aluno_selecionado');
    const nomeAlunoSel = document.getElementById('nome_aluno_sel');
    const limparBtn = document.getElementById('limpar_aluno');
    let timeoutBusca = null;

    function buscarAlunos(q) {
        const url = "{{ url_for('financeiro.buscar_alunos_mensalidades') }}?academia_id=" + encodeURIComponent(academiaId) + (q ? "&busca=" + encodeURIComponent(q) : "");
        fetch(url)
            .then(r => r.json())
            .then(alunos => {
                listaAlunos.innerHTML = '';
                listaAlunos.style.display = 'block';
                if (alunos.length === 0) {
                    listaAlunos.innerHTML = '<div class="p-3 text-muted text-center">Nenhum aluno encontrado</div>';
                } else {
                    alunos.forEach(a => {
                        const div = document.createElement('div');
                        div.className = 'p-2 border-bottom cursor-pointer aluno-item';
                        div.style.cursor = 'pointer';
                        const inicial = (a.nome || '?').charAt(0).toUpperCase();
                        const imgHtml = a.foto_url
                            ? '<img src="' + a.foto_url + '" alt="" class="rounded-circle me-2 flex-shrink-0" style="width:36px;height:36px;object-fit:cover">'
                            : '<span class="rounded-circle bg-secondary text-white d-inline-flex align-items-center justify-content-center me-2 flex-shrink-0" style="width:36px;height:36px;font-size:0.9rem">' + inicial + '</span>';
                        div.innerHTML = '<div class="d-flex align-items-center">' + imgHtml + '<span>' + (a.nome || '-') + '</span></div>';
                        div.addEventListener('click', function() {
                            alunoIdInput.value = a.id;
                            nomeAlunoSel.textContent = a.nome || '-';
                            alunoSelecionado.classList.remove('d-none');
                            buscaInput.classList.add('d-none');
                            listaAlunos.style.display = 'none';
                        });
                        listaAlunos.appendChild(div);
                    });
                }
            })
            .catch(() => { listaAlunos.innerHTML = '<div class="p-3 text-danger text-center">Erro ao buscar</div>'; });
    }

    buscaInput.addEventListener('input', function() {
        clearTimeout(timeoutBusca);
        const q = this.value.trim();
        if (q.length >= 1) {
            timeoutBusca = setTimeout(() => buscarAlunos(q), 250);
        } else if (q.length === 0) {
            buscarAlunos('');
        }
    });
    buscaInput.addEventListener('focus', function() {
        if (this.value.trim()) buscarAlunos(this.value.trim());
    });

    limparBtn.addEventListener('click', function() {
        alunoIdInput.value = '';
        alunoSelecionado.classList.add('d-none');
        buscaInput.classList.remove('d-none');
        buscaInput.value = '';
        buscaInput.focus();
    });

    document.getElementById('form-aplicar').addEventListener('submit', function(e) {
        if (!alunoIdInput.value) {
            e.preventDefault();
            alert('Selecione um aluno.');
            return false;
        }
    });

    var hoje = new Date();
    document.getElementById('data_inicio').value = hoje.toISOString().slice(0, 10);
    var fimAno = new Date(hoje.getFullYear(), 11, 31);
    document.getElementById('data_fim').value = fimAno.toISOString().slice(0, 10);
})();
</script>
{% endblock %}
