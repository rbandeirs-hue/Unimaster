{% extends "base.html" %}
{% block title %}Simular Categorias{% endblock %}
{% block content %}

<div class="container mt-3 mt-md-4 px-2 px-md-3">
    <div class="mb-3 mb-md-4">
        {% set back_url = back_url or get_back_url_default() %}
{% include 'components/botao_voltar.html' %}
        <h2 class="h5 h4-md fw-bold text-primary mb-2">Simular Categorias</h2>
        <p class="text-muted mb-0 small">Informe peso, data de nascimento e sexo para ver as categorias disponíveis.</p>
    </div>

    {% if alunos|length > 1 and not aluno %}
    <div class="card shadow-sm mb-3 mb-md-4">
        <div class="card-body p-3 p-md-4">
            <label class="form-label fw-semibold">Selecione o aluno:</label>
            <select class="form-select form-select-lg" onchange="if(this.value) window.location.href='{{ url_for('painel_responsavel.simular_categorias') }}?aluno_id='+this.value">
                <option value="">Selecione um aluno</option>
                {% for a in alunos %}
                <option value="{{ a.get('id') }}" {% if aluno and aluno.get('id') == a.get('id') %}selected{% endif %}>{{ a.get('nome') }}</option>
                {% endfor %}
            </select>
        </div>
    </div>
    {% endif %}

    <div class="card shadow-sm">
        <div class="card-body p-3 p-md-4">
            <form method="POST">
                {% if aluno %}
                <input type="hidden" name="aluno_id" value="{{ aluno.get('id') }}">
                {% endif %}
                <div class="row g-3">
                    <div class="col-12 col-md-4">
                        <label for="peso" class="form-label fw-semibold">Peso (kg) <span class="text-danger">*</span></label>
                        <input type="number" step="0.1" id="peso" name="peso" class="form-control form-control-lg" 
                               value="{{ peso or (aluno.get('peso') if aluno else '') }}" 
                               required placeholder="Ex: 65.5">
                    </div>
                    <div class="col-12 col-md-4">
                        <label for="data_nascimento" class="form-label fw-semibold">Data de Nascimento <span class="text-danger">*</span></label>
                        <input type="date" id="data_nascimento" name="data_nascimento" class="form-control form-control-lg" 
                               value="{{ data_nascimento or '' }}" 
                               required>
                    </div>
                    <div class="col-12 col-md-4">
                        <label for="sexo" class="form-label fw-semibold">Sexo <span class="text-danger">*</span></label>
                        <select id="sexo" name="sexo" class="form-select form-select-lg" required>
                            <option value="">Selecione</option>
                            <option value="M" {% if sexo == 'M' or (sexo is none and aluno and aluno.get('sexo') == 'M') %}selected{% endif %}>Masculino</option>
                            <option value="F" {% if sexo == 'F' or (sexo is none and aluno and aluno.get('sexo') == 'F') %}selected{% endif %}>Feminino</option>
                        </select>
                    </div>
                </div>
                <div class="mt-3">
                    <button type="submit" class="btn btn-primary btn-lg w-100 w-md-auto">
                        <i class="bi bi-search me-1"></i> Buscar Categorias
                    </button>
                </div>
            </form>
        </div>
    </div>

    {% if idade_calculada is defined and idade_calculada is not none %}
    <div class="card shadow-sm mt-3 mt-md-4">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0 h6"><i class="bi bi-info-circle me-2"></i> Informações Calculadas</h5>
        </div>
        <div class="card-body p-3 p-md-4">
            <div class="row g-2 g-md-3">
                <div class="col-6 col-md-3">
                    <div class="small text-muted">Peso</div>
                    <strong>{{ peso }} kg</strong>
                </div>
                <div class="col-6 col-md-3">
                    <div class="small text-muted">Idade (ano civil)</div>
                    <strong>{{ idade_calculada }} anos</strong>
                </div>
                <div class="col-6 col-md-3">
                    <div class="small text-muted">Sexo</div>
                    <strong>{{ 'Masculino' if sexo == 'M' else 'Feminino' }}</strong>
                </div>
                <div class="col-6 col-md-3">
                    <div class="small text-muted">Categorias encontradas</div>
                    <strong>{{ categorias_disponiveis|length if categorias_disponiveis else 0 }}</strong>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {% if categorias_disponiveis is defined and categorias_disponiveis and categorias_disponiveis|length > 0 %}
    <div class="card shadow-sm mt-3 mt-md-4">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0 h6"><i class="bi bi-trophy-fill me-2"></i> Categorias Disponíveis</h5>
        </div>
        <div class="card-body p-0 p-md-3">
            <!-- Tabela Desktop -->
            <div class="table-responsive d-none d-md-block">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Gênero</th>
                            <th>Classe</th>
                            <th>Categoria</th>
                            <th>Nome Categoria</th>
                            <th>Peso Mín</th>
                            <th>Peso Máx</th>
                            <th>Idade Mín</th>
                            <th>Idade Máx</th>
                            <th>Descrição</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for cat in categorias_disponiveis %}
                        <tr>
                            <td>{{ cat.get('id', '-') }}</td>
                            <td>{{ cat.get('genero', '-') }}</td>
                            <td>{{ cat.get('id_classe') or '-' }}</td>
                            <td>{{ cat.get('categoria') or '-' }}</td>
                            <td><strong>{{ cat.get('nome_categoria', '-') }}</strong></td>
                            <td>{{ cat.get('peso_min') if cat.get('peso_min') else '-' }}</td>
                            <td>{{ cat.get('peso_max') if cat.get('peso_max') else '-' }}</td>
                            <td>{{ cat.get('idade_min') if cat.get('idade_min') else '-' }}</td>
                            <td>{{ cat.get('idade_max') if cat.get('idade_max') else '-' }}</td>
                            <td>{{ cat.get('descricao') or '-' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <!-- Cards Mobile -->
            <div class="d-md-none">
                {% for cat in categorias_disponiveis %}
                <div class="card border-0 border-bottom rounded-0">
                    <div class="card-body p-3">
                        <h6 class="fw-bold text-success mb-2">{{ cat.get('nome_categoria', '-') }}</h6>
                        <div class="row g-2 small">
                            <div class="col-6"><strong>ID:</strong> {{ cat.get('id', '-') }}</div>
                            <div class="col-6"><strong>Gênero:</strong> {{ cat.get('genero', '-') }}</div>
                            <div class="col-6"><strong>Classe:</strong> {{ cat.get('id_classe') or '-' }}</div>
                            <div class="col-6"><strong>Categoria:</strong> {{ cat.get('categoria') or '-' }}</div>
                            <div class="col-6"><strong>Peso Mín:</strong> {{ cat.get('peso_min') if cat.get('peso_min') else '-' }}</div>
                            <div class="col-6"><strong>Peso Máx:</strong> {{ cat.get('peso_max') if cat.get('peso_max') else '-' }}</div>
                            <div class="col-6"><strong>Idade Mín:</strong> {{ cat.get('idade_min') if cat.get('idade_min') else '-' }}</div>
                            <div class="col-6"><strong>Idade Máx:</strong> {{ cat.get('idade_max') if cat.get('idade_max') else '-' }}</div>
                            {% if cat.get('descricao') %}
                            <div class="col-12">
                                <strong>Descrição:</strong> {{ cat.get('descricao') }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% elif idade_calculada is defined and idade_calculada is not none %}
    <div class="alert alert-warning mt-3 mt-md-4">
        <i class="bi bi-exclamation-triangle me-2"></i>
        <strong>Nenhuma categoria encontrada</strong> para os dados informados. Verifique se:
        <ul class="mb-0 mt-2 small">
            <li>O peso está dentro da faixa permitida</li>
            <li>A idade está dentro da faixa permitida</li>
            <li>O sexo está correto (M ou F)</li>
            <li>Existem categorias cadastradas na tabela <code>categorias</code></li>
        </ul>
    </div>
    {% endif %}
</div>

<style>
@media (max-width: 767.98px) {
    .form-control-lg, .form-select-lg {
        font-size: 16px; /* Evita zoom no iOS */
        padding: 0.75rem;
    }
    .btn-lg {
        padding: 0.75rem 1.5rem;
        font-size: 1rem;
        min-height: 44px; /* Tamanho mínimo para touch */
    }
    .card-body {
        font-size: 0.9rem;
    }
}
</style>

{% endblock %}
