{% extends "base.html" %}
{% block title %}Editar Aluno{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/photo-cropper.css') }}">
{% endblock %}
{% block content %}

<style>
    .card {
        border-radius: 1rem;
    }
    @media (max-width: 767.98px) {
        .editar-aluno-page .container-fluid { padding-left: 0.75rem; padding-right: 0.75rem; }
        .editar-aluno-page .card { border-radius: 0.6rem; }
        .editar-aluno-page .card-body { padding: 1rem !important; }
        .editar-aluno-page .display-6 { font-size: 1.35rem; }
        .editar-aluno-page .lead { font-size: 0.9rem; }
        .editar-aluno-page .btn-lg { width: 100%; margin-top: 0.5rem; }
        .editar-aluno-page .d-flex.justify-content-between.mt-4 { flex-direction: column-reverse; gap: 0.5rem; }
        .editar-aluno-page .d-flex.justify-content-between.mt-4 .btn { width: 100%; margin: 0 !important; }
        .editar-aluno-page .form-check { margin-bottom: 0.5rem; }
        .editar-aluno-page .d-flex.flex-wrap.gap-3 { flex-direction: column; gap: 0.5rem !important; }
        .editar-aluno-page .d-flex.flex-wrap.gap-2 { flex-direction: column; gap: 0.35rem !important; }
        .editar-aluno-page .input-group .btn { min-width: 44px; }
        .editar-aluno-page #btnMesmoResponsavelFinanceiro { margin-top: 0 !important; }
        .editar-aluno-page .align-items-end .col-md-2 { margin-top: 0.5rem; }
        .editar-aluno-page #miniatura { width: 100px; height: 100px; }
        .editar-aluno-page .d-flex.flex-column.flex-md-row.gap-4 { flex-direction: column; gap: 1rem !important; }
        .editar-aluno-page .camera-content { width: 95%; }
        .editar-aluno-page h6.border-bottom { font-size: 0.95rem; }
    }
    #miniatura {
        width: 150px; height: 150px;
        object-fit: cover;
        border-radius: 50%;
        border: 3px solid #0d6efd;
    }
    .camera-modal {
        display: none;
        position: fixed; top: 0; left: 0;
        width: 100%; height: 100%;
        justify-content: center; align-items: center;
        background: rgba(0,0,0,.9);
        z-index: 9999;
    }
    .camera-content { width: 90%; max-width: 480px; text-align: center; }
    .camera-content video, .camera-content canvas {
        width: 100%;
        max-width: 100%;
        height: auto;
        max-height: 70vh;
        border-radius: 10px;
        border: 2px solid #ddd;
        margin-bottom: 10px;
        object-fit: contain;
        background: #000;
    }
    
    @media (max-width: 768px) {
        .camera-modal {
            padding: 10px;
        }
        .camera-content {
            width: 100%;
            max-width: 100%;
        }
        .camera-content video,
        .camera-content canvas {
            max-height: 60vh;
        }
        .camera-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 5px;
        }
        .camera-buttons button {
            flex: 1 1 auto;
            min-width: 100px;
            font-size: 0.9rem;
            padding: 0.5rem;
        }
    }
    .camera-buttons button { margin: 5px; }
</style>

<div class="container-fluid px-3 px-md-4 mt-4 editar-aluno-page">

    <div class="text-center mb-4">
        <h2 class="display-6 text-primary fw-bold">Editar Aluno</h2>
        <p class="lead text-muted">Atualize os dados necessários abaixo.</p>
    </div>

    <div class="card shadow-lg p-3 p-md-4">

        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-person-lines-fill me-2"></i>Dados do Aluno</h5>
        </div>

        <div class="card-body p-4">

            <form method="POST" enctype="multipart/form-data">
                <input type="hidden" name="next" value="{{ back_url }}">

                <!-- ===================================================== -->
                <!-- 1 — Dados pessoais -->
                <!-- ===================================================== -->

                <h6 class="border-bottom pb-2 mb-3 text-secondary fw-bold">
                    <i class="bi bi-person-fill me-1"></i> Dados Pessoais
                </h6>

                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label class="form-label fw-semibold">Nome completo *</label>
                        <input type="text" class="form-control" name="nome" required
                               placeholder="Nome completo"
                               value="{{ aluno.nome }}">
                    </div>

                    <div class="col-md-4 mb-3">
                        <label class="form-label fw-semibold">Data de nascimento *</label>
                        <input type="date" class="form-control" name="data_nascimento"
                               placeholder="Selecione a data"
                               value="{{ aluno.data_nascimento }}" required>
                    </div>

                    <div class="col-md-4 mb-3">
                        <label class="form-label fw-semibold">Nacionalidade</label>
                        <input type="text" class="form-control" name="nacionalidade"
                               placeholder="Nacionalidade"
                               value="{{ aluno.nacionalidade or '' }}">
                    </div>

                    <div class="col-md-4 mb-3">
                        <label class="form-label fw-semibold">Graduação *</label>
                        <select class="form-control" name="graduacao_id" required>
                            <option value="">Selecione</option>
                            {% for g in graduacoes %}
                            <option value="{{ g.id }}"
                                {% if aluno.graduacao_id == g.id %}selected{% endif %}>
                                {{ g.get('faixa', '') }} - {{ g.get('graduacao', '') }}{% if g.get('categoria') %} - {{ g.get('categoria') }}{% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label fw-semibold">Sexo</label>
                        <select class="form-control" name="sexo">
                            <option value="" selected>Selecione</option>
                            <option value="M" {% if aluno.sexo == 'M' %}selected{% endif %}>Masculino</option>
                            <option value="F" {% if aluno.sexo == 'F' %}selected{% endif %}>Feminino</option>
                            <option value="O" {% if aluno.sexo == 'O' %}selected{% endif %}>Outro</option>
                        </select>
                    </div>
                </div>

                <!-- ===================================================== -->
                <!-- 2 — Vínculos -->
                <!-- ===================================================== -->

                <h6 class="border-bottom pb-2 mb-3 mt-4 text-secondary fw-bold">
                    <i class="bi bi-diagram-3 me-1"></i> Vínculos
                </h6>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-semibold">Academia</label>
                        <input type="text" class="form-control" placeholder="Academia"
                               value="{{ aluno.academia_nome }}" readonly>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-semibold">Associação</label>
                        <input type="text" class="form-control" placeholder="Associação"
                               value="{{ aluno.associacao_nome }}" readonly>
                    </div>
                </div>

                <!-- ===================================================== -->
                <!-- 3 — Filiação -->
                <!-- ===================================================== -->

                <h6 class="border-bottom pb-2 mb-3 mt-4 text-secondary fw-bold">
                    <i class="bi bi-people-fill me-1"></i> Filiação
                </h6>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-semibold">Nome do Pai</label>
                        <input type="text" class="form-control" name="nome_pai"
                               placeholder="Nome do pai"
                               value="{{ aluno.nome_pai }}">
                    </div>

                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-semibold">Nome da Mãe</label>
                        <input type="text" class="form-control" name="nome_mae"
                               placeholder="Nome da mãe"
                               value="{{ aluno.nome_mae }}">
                    </div>
                </div>

                <!-- ===================================================== -->
                <!-- 4 — Classificação -->
                <!-- ===================================================== -->

                {% set pode_editar_turma_modalidade = current_user.has_role('admin') or current_user.has_role('gestor_academia') %}
                <h6 class="border-bottom pb-2 mb-3 mt-4 text-secondary fw-bold">
                    <i class="bi bi-person-badge me-1"></i> {% if pode_editar_turma_modalidade %}Turma e Modalidades{% else %}Dados adicionais{% endif %}
                </h6>

                {% if pode_editar_turma_modalidade %}
                <div class="row">
                    <div class="col-md-8 mb-3">
                        <label class="form-label fw-semibold">Turma(s)</label>
                        <p class="small text-muted mb-2">Marque uma ou mais turmas em que o aluno está matriculado</p>
                        <div class="d-flex flex-wrap gap-3">
                            {% for t in turmas %}
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="turmas_ids" value="{{ t.TurmaID }}" id="turma_{{ t.TurmaID }}"
                                    {% if t.TurmaID in (aluno.turmas_ids or []) or (not (aluno.turmas_ids or []) and aluno.TurmaID == t.TurmaID) %}checked{% endif %}>
                                <label class="form-check-label" for="turma_{{ t.TurmaID }}">
                                    {{ t.Nome }} ({{ t.Classificacao }}{% if t.DiasHorario %}, {{ t.DiasHorario }}{% endif %})
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="cadastro_zempo_gestor" name="cadastro_zempo" value="1"
                           {% if aluno.zempo or aluno.data_cadastro_zempo %}checked{% endif %}>
                    <label class="form-check-label fw-semibold" for="cadastro_zempo_gestor">Cadastro no Zempo</label>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label fw-semibold">Registro Zempo nº</label>
                        <input type="text" class="form-control" name="zempo" id="zempo_gestor"
                               placeholder="Número do registro Zempo"
                               value="{{ aluno.zempo or '' }}">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label fw-semibold">Data de Cadastro Zempo</label>
                        <input type="date" class="form-control" name="data_cadastro_zempo" id="data_cadastro_zempo_gestor"
                               placeholder="Data de cadastro"
                               value="{{ aluno.data_cadastro_zempo or '' }}">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label fw-semibold">Peso</label>
                        <input type="number" step="0.1" class="form-control" name="peso"
                               placeholder="Peso (kg)"
                               value="{{ aluno.peso }}">
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-semibold">Modalidades *</label>
                    <div class="d-flex flex-wrap gap-2">
                        {% for m in modalidades %}
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox"
                                   name="aluno_modalidade_ids"
                                   value="{{ m.id }}"
                                   {% if m.id in aluno.modalidades_ids %}checked{% endif %}>
                            <label class="form-check-label">{{ m.nome }}</label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% else %}
                {# Aluno e responsável: exibem turma e modalidades somente leitura, e podem editar Zempo e Peso #}
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-semibold">Turma(s)</label>
                        <input type="text" class="form-control" readonly
                               value="{{ turmas_display or '—' }}">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-semibold">Modalidades</label>
                        <input type="text" class="form-control" readonly
                               value="{{ modalidades_display or '—' }}">
                    </div>
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="cadastro_zempo" name="cadastro_zempo" value="1"
                           {% if aluno.zempo or aluno.data_cadastro_zempo %}checked{% endif %}>
                    <label class="form-check-label fw-semibold" for="cadastro_zempo">Cadastro no Zempo</label>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label fw-semibold">Registro Zempo nº</label>
                        <input type="text" class="form-control" name="zempo" id="zempo_editar"
                               placeholder="Número do registro Zempo"
                               value="{{ aluno.zempo or '' }}">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label fw-semibold">Data de Cadastro Zempo</label>
                        <input type="date" class="form-control" name="data_cadastro_zempo" id="data_cadastro_zempo_editar"
                               placeholder="Data de cadastro"
                               value="{{ aluno.data_cadastro_zempo or '' }}">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label fw-semibold">Peso</label>
                        <input type="number" step="0.1" class="form-control" name="peso"
                               placeholder="Peso (kg)"
                               value="{{ aluno.peso }}">
                    </div>
                </div>
                {# Campos hidden para manter turmas e modalidades ao enviar o form (não alteram) #}
                {% for tid in (aluno.turmas_ids or []) %}
                <input type="hidden" name="turmas_ids" value="{{ tid }}">
                {% endfor %}
                {% if not (aluno.turmas_ids or []) and aluno.TurmaID %}
                <input type="hidden" name="turmas_ids" value="{{ aluno.TurmaID }}">
                {% endif %}
                {% for mid in (aluno.modalidades_ids or []) %}
                <input type="hidden" name="aluno_modalidade_ids" value="{{ mid }}">
                {% endfor %}
                {% endif %}

                <!-- ===================================================== -->
                <!-- 5 — Documentos -->
                <!-- ===================================================== -->

                <h6 class="border-bottom pb-2 mb-3 mt-4 text-secondary fw-bold">
                    <i class="bi bi-file-text me-1"></i> Documentos
                </h6>

                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label fw-semibold">Data da Última Graduação</label>
                        <input type="date" class="form-control" name="ultimo_exame_faixa"
                               placeholder="Data da última graduação"
                               value="{{ aluno.ultimo_exame_faixa or '' }}">
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label fw-semibold">CPF</label>
                        <input type="text" class="form-control" name="cpf"
                               placeholder="CPF"
                               value="{{ aluno.cpf }}" data-mask="cpf">
                    </div>

                    <div class="col-md-4 mb-3">
                        <label class="form-label fw-semibold">RG</label>
                        <input type="text" class="form-control" name="rg"
                               placeholder="RG"
                               value="{{ aluno.rg }}">
                    </div>

                    <div class="col-md-4 mb-3">
                        <label class="form-label fw-semibold">Órgão Emissor / UF</label>
                        <input type="text" class="form-control" name="orgao_emissor"
                               placeholder="Ex: SDS/PE"
                               value="{{ aluno.orgao_emissor }}">
                    </div>

                    <div class="col-md-4 mb-3">
                        <label class="form-label fw-semibold">Data de emissão</label>
                        <input type="date" class="form-control" name="rg_data_emissao"
                               placeholder="Data de emissão"
                               value="{{ aluno.rg_data_emissao }}">
                    </div>
                </div>

                <!-- ===================================================== -->
                <!-- 6 — Endereço -->
                <!-- ===================================================== -->

                <h6 class="border-bottom pb-2 mb-3 mt-4 text-secondary fw-bold">
                    <i class="bi bi-geo-alt-fill me-1"></i> Endereço
                </h6>

                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label class="form-label fw-semibold">CEP</label>
                        <div class="input-group">
                            <input type="text" class="form-control" name="cep" id="cep" data-mask="cep"
                                   placeholder="00000-000"
                                   value="{{ aluno.cep }}">
                            <button class="btn btn-outline-primary" type="button" id="btnBuscarCEP">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-semibold">Endereço</label>
                        <input type="text" class="form-control" name="endereco"
                               placeholder="Endereço completo"
                               id="endereco" value="{{ aluno.endereco }}">
                    </div>

                    <div class="col-md-3 mb-3">
                        <label class="form-label fw-semibold">Número</label>
                        <input type="text" class="form-control" name="numero" placeholder="Número"
                               value="{{ aluno.numero }}">
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label fw-semibold">Bairro</label>
                        <input type="text" class="form-control" name="bairro" id="bairro"
                               placeholder="Bairro"
                               value="{{ aluno.bairro }}">
                    </div>

                    <div class="col-md-4 mb-3">
                        <label class="form-label fw-semibold">Cidade</label>
                        <input type="text" class="form-control" name="cidade" id="cidade"
                               placeholder="Cidade"
                               value="{{ aluno.cidade }}">
                    </div>

                    <div class="col-md-4 mb-3">
                        <label class="form-label fw-semibold">Estado</label>
                        <input type="text" class="form-control" name="estado" id="estado"
                               placeholder="UF"
                               value="{{ aluno.estado }}">
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-semibold">Complemento</label>
                    <input type="text" class="form-control" name="complemento"
                           placeholder="Complemento"
                           value="{{ aluno.complemento }}">
                </div>

                <!-- ===================================================== -->
                <!-- 7 — Contatos -->
                <!-- ===================================================== -->

                <h6 class="border-bottom pb-2 mb-3 mt-4 text-secondary fw-bold">
                    <i class="bi bi-telephone-fill me-1"></i> Contatos
                </h6>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-semibold">Grau de parentesco</label>
                        <select class="form-control" name="responsavel_grau_parentesco" id="responsavel_grau_parentesco">
                            <option value="" {% if not aluno.responsavel_parentesco %}selected{% endif %}>Selecione</option>
                            <option value="Pai" {% if aluno.responsavel_parentesco == 'Pai' %}selected{% endif %}>Pai</option>
                            <option value="Mãe" {% if aluno.responsavel_parentesco == 'Mãe' %}selected{% endif %}>Mãe</option>
                            <option value="Outro" {% if aluno.responsavel_parentesco and aluno.responsavel_parentesco not in ['Pai','Mãe'] %}selected{% endif %}>Outro</option>
                        </select>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-semibold">Responsável (menor)</label>
                        <input type="text" class="form-control" name="responsavel_nome" id="responsavel_nome"
                               placeholder="Nome do responsável"
                               value="{{ aluno.responsavel_nome }}" readonly>
                    </div>
                </div>

                <div class="row" id="responsavel_tipo_wrapper" style="display: none;">
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-semibold">Tipo</label>
                        <input type="text" class="form-control" name="responsavel_parentesco" id="responsavel_parentesco"
                               placeholder="Ex: Tio, Avó, Avô..."
                               value="{% if aluno.responsavel_parentesco and aluno.responsavel_parentesco not in ['Pai','Mãe'] %}{{ aluno.responsavel_parentesco }}{% endif %}">
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-semibold">Email *</label>
                        <input type="email" class="form-control" name="email"
                               placeholder="email@exemplo.com"
                               value="{{ aluno.email }}" required>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-semibold">Telefone Celular *</label>
                        <input type="text" class="form-control" data-mask="phone"
                               placeholder="(00) 00000-0000"
                               name="telefone_celular" value="{{ aluno.telefone_celular }}">
                    </div>

                    <div class="col-md-4 mb-3">
                        <label class="form-label fw-semibold">Telefone Residencial</label>
                        <input type="text" class="form-control" data-mask="phone"
                               placeholder="(00) 0000-0000"
                               name="telefone_residencial" value="{{ aluno.telefone_residencial }}">
                    </div>

                    <div class="col-md-4 mb-3">
                        <label class="form-label fw-semibold">Telefone Comercial</label>
                        <input type="text" class="form-control" data-mask="phone"
                               placeholder="(00) 0000-0000"
                               name="telefone_comercial" value="{{ aluno.telefone_comercial }}">
                    </div>

                    <div class="col-md-4 mb-3">
                        <label class="form-label fw-semibold">Outro Telefone</label>
                        <input type="text" class="form-control" data-mask="phone"
                               placeholder="(00) 0000-0000"
                               name="telefone_outro" value="{{ aluno.telefone_outro }}">
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-semibold">Observações</label>
                    <textarea class="form-control" name="observacoes" rows="3"
                              placeholder="Observações adicionais">{{ aluno.observacoes }}</textarea>
                </div>

                <!-- ===================================================== -->
                <!-- 8 — Responsável Financeiro -->
                <!-- ===================================================== -->

                <h6 class="border-bottom pb-2 mb-3 mt-4 text-secondary fw-bold">
                    <i class="bi bi-cash me-1"></i> Responsável Financeiro
                </h6>

                <div class="row align-items-end">
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-semibold">Nome</label>
                        <input type="text" class="form-control" name="responsavel_financeiro_nome"
                               id="responsavel_financeiro_nome"
                               placeholder="Nome do responsável financeiro"
                               value="{{ aluno.responsavel_financeiro_nome }}">
                    </div>

                    <div class="col-md-4 mb-3">
                        <label class="form-label fw-semibold">CPF</label>
                        <input type="text" class="form-control" data-mask="cpf"
                               placeholder="CPF do responsável financeiro"
                               name="responsavel_financeiro_cpf"
                               value="{{ aluno.responsavel_financeiro_cpf }}">
                    </div>

                    <div class="col-md-2 mb-3 d-grid">
                        <button type="button" class="btn btn-outline-primary mt-md-4"
                                id="btnMesmoResponsavelFinanceiro">
                            <i class="bi bi-person-check"></i>
                            Mesmo aluno
                        </button>
                    </div>
                </div>

                <!-- ===================================================== -->
                <!-- 9 — Foto -->
                <!-- ===================================================== -->

                <h6 class="border-bottom pb-2 mb-3 mt-4 text-secondary fw-bold">
                    <i class="bi bi-camera-fill me-1"></i> Foto
                </h6>

                <div class="d-flex flex-column flex-md-row align-items-start gap-4">

                    <div class="text-center">
                        <label class="fw-semibold">Foto atual</label><br>
                        <img id="miniatura"
                             src="{{ url_for('static', filename='uploads/' ~ aluno.foto) if aluno.foto else '' }}"
                             class="{{ 'd-block' if aluno.foto else 'd-none' }}">
                        <input type="hidden" name="foto" id="fotoInput">
                    </div>

                    <div class="flex-grow-1">
                        <label class="form-label fw-semibold">Enviar nova foto</label>
                        <div class="d-flex flex-column flex-md-row gap-2">

                            <button type="button" class="btn btn-primary btn-sm d-flex align-items-center gap-2"
                                    id="btnAbrirCamera">
                                <i class="bi bi-camera-fill"></i> Câmera
                            </button>

                            <input type="file" name="foto_arquivo" id="fotoArquivoEditarAluno" class="form-control" accept="image/*">

                        </div>
                    </div>
                </div>

                <!-- ===================================================== -->
                <!-- Botões finais -->
                <!-- ===================================================== -->

                <div class="d-flex justify-content-between mt-4 pt-3 border-top">
                    {% set back_url = back_url or get_back_url_default() %}
{% include 'components/botao_voltar.html' %}

                    <button type="submit" class="btn btn-success btn-lg">
                        <i class="bi bi-save me-2"></i> Salvar Alterações
                    </button>
                </div>

            </form>
        </div>
    </div>
</div>

<!-- ===================================================== -->
<!-- MODAL DE CÂMERA -->
<!-- ===================================================== -->

<div class="camera-modal" id="cameraModal">
    <div class="camera-content">
        <video id="cameraVideo" autoplay playsinline></video>
        <canvas id="cameraCanvas" style="display:none;"></canvas>

        <div class="camera-buttons">
            <button class="btn btn-success" id="btnCapturar">Capturar</button>
            <button class="btn btn-primary" id="btnConfirmarFoto" style="display:none;">Confirmar</button>
            <button class="btn btn-warning" id="btnTirarNovamente" style="display:none;">Refazer</button>
            <button class="btn btn-info text-white" id="btnTrocarCameraModal">
                <i class="bi bi-arrow-repeat"></i> <span id="btnTrocarCameraText">Trocar Câmera</span>
            </button>
            <button class="btn btn-danger" id="btnFecharModal">Fechar</button>
        </div>
    </div>
</div>

<!-- ===================================================== -->
<!-- JS — Câmera, CEP e Máscaras -->
<!-- ===================================================== -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>

<script>
    let stream, devices = [], currentIndex = 0, isFrontCamera = false;
    let usingFrontCamera = true;
    let frontCameras = [], backCameras = [], currentDeviceId = null;

    async function listarCameras() {
        // Solicitar permissão primeiro para obter labels dos dispositivos
        try {
            await navigator.mediaDevices.getUserMedia({ video: true });
        } catch (e) {
            console.error('Erro ao solicitar permissão:', e);
        }
        const medias = await navigator.mediaDevices.enumerateDevices();
        devices = medias.filter(d => d.kind === "videoinput");
        
        // Classificar câmeras em frontais e traseiras
        frontCameras = [];
        backCameras = [];
        for (let device of devices) {
            const label = device.label.toLowerCase();
            if (label.includes('front') || label.includes('facing') || label.includes('user')) {
                frontCameras.push(device);
            } else {
                backCameras.push(device);
            }
        }
        
        // Mostrar botão ao abrir a câmera
        $('#btnTrocarCameraModal').css('display', 'inline-block');
    }

    function atualizarTextoBotaoTrocarCamera() {
        const btnText = document.getElementById('btnTrocarCameraText');
        if (btnText) {
            const temAmbas = frontCameras.length > 0 && backCameras.length > 0;
            if (temAmbas) {
                // Se identificamos ambas, usar texto dinâmico
                if (isFrontCamera) {
                    btnText.textContent = 'Câmera Traseira';
                } else {
                    btnText.textContent = 'Câmera Dianteira';
                }
            } else {
                // Caso contrário, usar texto genérico
                btnText.textContent = 'Trocar Câmera';
            }
        }
    }

    async function abrirCameraModal(deviceId = null) {
        let video = document.getElementById("cameraVideo");
        
        // Parar stream anterior completamente
        if (stream) {
            try {
                stream.getTracks().forEach(t => {
                    t.stop();
                });
            } catch (e) {
                console.warn('Erro ao parar tracks:', e);
            }
            stream = null;
        }
        
        // Limpar srcObject antes de iniciar novo stream
        video.srcObject = null;
        
        // Aguardar um pouco mais para garantir que o stream anterior foi completamente liberado
        await new Promise(resolve => setTimeout(resolve, 300));

        let constraints = { video: true };
        let triedExact = false;
        
        if (deviceId) {
            // Verificar se o deviceId ainda existe na lista
            const deviceExists = devices.some(d => d.deviceId === deviceId);
            if (deviceExists) {
                // Tentar primeiro com exact, se falhar tentar com ideal
                constraints.video = { deviceId: { exact: deviceId } };
                triedExact = true;
            } else {
                console.warn('DeviceId não encontrado, usando câmera padrão');
            }
        }

        try {
            stream = await navigator.mediaDevices.getUserMedia(constraints);
            video.srcObject = stream;

            // Detectar tipo de câmera após stream estar ativo
            const track = stream.getVideoTracks()[0];
            if (track) {
                const settings = track.getSettings();
                currentDeviceId = settings.deviceId;
                
                // Se facingMode é 'user', é frontal. Se 'environment' ou não definido, tentar detectar pelo label
                if (settings.facingMode === 'user') {
                    isFrontCamera = true;
                } else if (settings.facingMode === 'environment') {
                    isFrontCamera = false;
                } else {
                    // Fallback: verificar se está na lista de frontais ou traseiras
                    const device = devices.find(d => d.deviceId === currentDeviceId);
                    if (device) {
                        const isInFront = frontCameras.some(d => d.deviceId === currentDeviceId);
                        const isInBack = backCameras.some(d => d.deviceId === currentDeviceId);
                        if (isInFront) {
                            isFrontCamera = true;
                        } else if (isInBack) {
                            isFrontCamera = false;
                        } else {
                            // Tentar detectar pelo label
                            const label = device.label.toLowerCase();
                            isFrontCamera = label.includes('front') || label.includes('facing') || label.includes('user');
                        }
                    } else {
                        isFrontCamera = false;
                    }
                }
            } else {
                isFrontCamera = false;
            }

            // Aplicar transformação apenas para câmera frontal (espelhar horizontalmente)
            if (isFrontCamera) {
                video.style.transform = 'scaleX(-1)';
            } else {
                video.style.transform = 'scaleX(1)';
            }

            // Atualizar texto do botão de trocar câmera
            atualizarTextoBotaoTrocarCamera();
            $('#btnTrocarCameraModal').css('display', 'inline-block');

            $('#cameraModal').fadeIn();
        } catch (e) {
            console.error('Erro ao acessar câmera com constraints:', e);
            
            // Se tentou com exact e falhou, tentar com ideal
            if (triedExact && deviceId) {
                try {
                    constraints.video = { deviceId: { ideal: deviceId } };
                    stream = await navigator.mediaDevices.getUserMedia(constraints);
                    video.srcObject = stream;
                    
                    // Detectar tipo de câmera após stream estar ativo
                    const track = stream.getVideoTracks()[0];
                    if (track) {
                        const settings = track.getSettings();
                        currentDeviceId = settings.deviceId;
                        
                        if (settings.facingMode === 'user') {
                            isFrontCamera = true;
                        } else if (settings.facingMode === 'environment') {
                            isFrontCamera = false;
                        } else {
                            const device = devices.find(d => d.deviceId === currentDeviceId);
                            if (device) {
                                const isInFront = frontCameras.some(d => d.deviceId === currentDeviceId);
                                const isInBack = backCameras.some(d => d.deviceId === currentDeviceId);
                                if (isInFront) {
                                    isFrontCamera = true;
                                } else if (isInBack) {
                                    isFrontCamera = false;
                                } else {
                                    const label = device.label.toLowerCase();
                                    isFrontCamera = label.includes('front') || label.includes('facing') || label.includes('user');
                                }
                            } else {
                                isFrontCamera = false;
                            }
                        }
                    } else {
                        isFrontCamera = false;
                    }

                    if (isFrontCamera) {
                        video.style.transform = 'scaleX(-1)';
                    } else {
                        video.style.transform = 'scaleX(1)';
                    }

                    $('#cameraModal').fadeIn();
                    return;
                } catch (e2) {
                    console.error('Erro ao acessar câmera com ideal:', e2);
                    // Se ainda falhar, tentar sem especificar deviceId
                    try {
                        constraints.video = true;
                        stream = await navigator.mediaDevices.getUserMedia(constraints);
                        video.srcObject = stream;
                        
                        const track = stream.getVideoTracks()[0];
                        if (track) {
                            const settings = track.getSettings();
                            currentDeviceId = settings.deviceId;
                            isFrontCamera = settings.facingMode === 'user';
                        }
                        
                        if (isFrontCamera) {
                            video.style.transform = 'scaleX(-1)';
                        } else {
                            video.style.transform = 'scaleX(1)';
                        }
                        
                        atualizarTextoBotaoTrocarCamera();
                        $('#cameraModal').fadeIn();
                        return;
                    } catch (e3) {
                        console.error('Erro ao acessar câmera padrão:', e3);
                    }
                }
            }
            
            alert('Não foi possível acessar a câmera: ' + e.message);
        }
    }

    async function startCamera() {
        if (stream) {
            try {
                stream.getTracks().forEach(t => t.stop());
            } catch (e) {
                console.warn('Erro ao parar tracks:', e);
            }
            stream = null;
        }

        const video = document.getElementById("cameraVideo");
        video.srcObject = null;
        await new Promise(resolve => setTimeout(resolve, 300));

        const constraints = {
            video: { facingMode: usingFrontCamera ? 'user' : 'environment' },
            audio: false
        };

        try {
            stream = await navigator.mediaDevices.getUserMedia(constraints);
            video.srcObject = stream;
            isFrontCamera = usingFrontCamera;
            video.style.transform = isFrontCamera ? 'scaleX(-1)' : 'scaleX(1)';
            atualizarTextoBotaoTrocarCamera();
            $('#btnTrocarCameraModal').css('display', 'inline-block !important');
            $('#cameraModal').fadeIn();
        } catch (e) {
            await listarCameras();
            await abrirCameraModal(devices[0]?.deviceId);
        }
    }

    $("#btnAbrirCamera").click(async function () {
        usingFrontCamera = true;
        await startCamera();
    });

    $("#btnTrocarCameraModal").click(async function () {
        usingFrontCamera = !usingFrontCamera;
        await startCamera();
    });

    $("#btnFecharModal").click(function () {
        $("#cameraModal").fadeOut();
        if (stream) stream.getTracks().forEach(t => t.stop());
        let video = document.getElementById("cameraVideo");
        video.style.transform = '';
    });

    $("#btnCapturar").click(function () {
        let video = document.getElementById("cameraVideo");
        let canvas = document.getElementById("cameraCanvas");
        let ctx = canvas.getContext("2d");

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        // Aplicar mesma transformação ao capturar (espelhar se for câmera frontal)
        if (isFrontCamera) {
            ctx.translate(canvas.width, 0);
            ctx.scale(-1, 1);
        }
        ctx.drawImage(video, 0, 0);

        $("#cameraCanvas").show();
        $("#cameraVideo").hide();
        $("#btnConfirmarFoto, #btnTirarNovamente").show();
        $("#btnCapturar").hide();
    });

    $("#btnTirarNovamente").click(function () {
        $("#cameraCanvas").hide();
        $("#cameraVideo").show();
        $("#btnConfirmarFoto, #btnTirarNovamente").hide();
        $("#btnCapturar").show();
        $("#btnTrocarCameraModal").css('display', 'inline-block');
        atualizarTextoBotaoTrocarCamera();
        // Restaurar transformação do video
        let video = document.getElementById("cameraVideo");
        if (isFrontCamera) {
            video.style.transform = 'scaleX(-1)';
        } else {
            video.style.transform = 'scaleX(1)';
        }
    });

    $("#btnConfirmarFoto").click(function () {
        const dataURL = document.getElementById("cameraCanvas").toDataURL("image/png");
        $("#fotoInput").val(dataURL);
        $("#miniatura").attr("src", dataURL).removeClass("d-none");
        $("#cameraModal").fadeOut();
        if (stream) stream.getTracks().forEach(t => t.stop());
    });

    /* ===================================================== */
    /* Máscaras */
    /* ===================================================== */

    function aplicarMascaraTelefone(input) {
        let v = input.value.replace(/\D/g, '');
        if (v.length > 11) v = v.slice(0, 11);

        if (v.length > 10) input.value = `(${v.slice(0, 2)}) ${v.slice(2, 7)}-${v.slice(7)}`;
        else if (v.length > 6) input.value = `(${v.slice(0, 2)}) ${v.slice(2, 6)}-${v.slice(6)}`;
        else if (v.length > 2) input.value = `(${v.slice(0, 2)}) ${v.slice(2)}`;
        else input.value = v;
    }

    document.querySelectorAll('input[data-mask="phone"]').forEach(el => {
        el.addEventListener('input', function () { aplicarMascaraTelefone(this); });
    });

    function aplicarMascaraCPF(input) {
        let v = input.value.replace(/\D/g, '');
        if (v.length > 11) v = v.slice(0, 11);

        if (v.length > 9) input.value = `${v.slice(0, 3)}.${v.slice(3, 6)}.${v.slice(6, 9)}-${v.slice(9)}`;
        else if (v.length > 6) input.value = `${v.slice(0, 3)}.${v.slice(3, 6)}.${v.slice(6)}`;
        else if (v.length > 3) input.value = `${v.slice(0, 3)}.${v.slice(3)}`;
        else input.value = v;
    }

    document.querySelectorAll('input[data-mask="cpf"]').forEach(el => {
        el.addEventListener('input', function () { aplicarMascaraCPF(this); });
    });

    function aplicarMascaraCEP(input) {
        let v = input.value.replace(/\D/g, '');
        if (v.length > 8) v = v.slice(0, 8);
        if (v.length > 5) input.value = `${v.slice(0, 5)}-${v.slice(5)}`;
        else input.value = v;
    }

    const cepInput = document.getElementById('cep');
    if (cepInput) {
        cepInput.addEventListener('input', function () { aplicarMascaraCEP(this); });
    }

    /* Consulta CEP */
    async function buscarCEP() {
        const cep = cepInput.value.replace(/\D/g, '');
        if (cep.length !== 8) {
            alert("CEP inválido.");
            return;
        }

        const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
        const data = await response.json();
        if (data.erro) {
            alert("CEP não encontrado.");
            return;
        }

        document.getElementById('endereco').value = data.logradouro || '';
        document.getElementById('bairro').value = data.bairro || '';
        document.getElementById('cidade').value = data.localidade || '';
        document.getElementById('estado').value = data.uf || '';
    }

    $("#btnBuscarCEP").click(buscarCEP);
    if (cepInput) {
        cepInput.addEventListener('blur', function () {
            if (this.value.replace(/\D/g, '').length === 8) buscarCEP();
        });
    }

    /* Usar aluno como responsável financeiro */
    $("#btnMesmoResponsavelFinanceiro").click(function () {
        $("#responsavel_financeiro_nome").val($("input[name='nome']").val());
        $("#responsavel_financeiro_cpf").val($("input[name='cpf']").val()).trigger('input');
    });

    function atualizarResponsavel() {
        const parentesco = document.getElementById('responsavel_grau_parentesco');
        const responsavelNome = document.getElementById('responsavel_nome');
        const tipoWrapper = document.getElementById('responsavel_tipo_wrapper');
        const tipoInput = document.getElementById('responsavel_parentesco');
        const nomePai = document.querySelector('input[name="nome_pai"]')?.value || '';
        const nomeMae = document.querySelector('input[name="nome_mae"]')?.value || '';

        if (!parentesco || !responsavelNome || !tipoWrapper || !tipoInput) return;

        if (parentesco.value === 'Pai') {
            responsavelNome.value = nomePai;
            responsavelNome.readOnly = true;
            tipoWrapper.style.display = 'none';
            tipoInput.value = '';
        } else if (parentesco.value === 'Mãe') {
            responsavelNome.value = nomeMae;
            responsavelNome.readOnly = true;
            tipoWrapper.style.display = 'none';
            tipoInput.value = '';
        } else if (parentesco.value === 'Outro') {
            responsavelNome.readOnly = false;
            tipoWrapper.style.display = 'block';
        } else {
            responsavelNome.value = '';
            responsavelNome.readOnly = true;
            tipoWrapper.style.display = 'none';
            tipoInput.value = '';
        }
    }

    document.getElementById('responsavel_grau_parentesco')?.addEventListener('change', atualizarResponsavel);
    document.querySelector('input[name="nome_pai"]')?.addEventListener('input', atualizarResponsavel);
    document.querySelector('input[name="nome_mae"]')?.addEventListener('input', atualizarResponsavel);
    atualizarResponsavel();

    // Cadastro Zempo: habilita/desabilita campos conforme checkbox (ambas seções: gestor e aluno)
    function atualizarCamposZempo() {
        var ids = [
            ['cadastro_zempo', 'zempo_editar', 'data_cadastro_zempo_editar'],
            ['cadastro_zempo_gestor', 'zempo_gestor', 'data_cadastro_zempo_gestor']
        ];
        ids.forEach(function(arr) {
            var marcado = document.getElementById(arr[0])?.checked;
            var zempo = document.getElementById(arr[1]);
            var dataZempo = document.getElementById(arr[2]);
            if (!zempo || !dataZempo) return;
            zempo.disabled = !marcado;
            dataZempo.disabled = !marcado;
            if (!marcado) {
                zempo.value = '';
                dataZempo.value = '';
            }
        });
    }
    document.getElementById('cadastro_zempo')?.addEventListener('change', atualizarCamposZempo);
    document.getElementById('cadastro_zempo_gestor')?.addEventListener('change', atualizarCamposZempo);
    atualizarCamposZempo();

</script>
{% endblock %}
{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
<script src="{{ url_for('static', filename='js/photo-cropper.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    var fa = document.getElementById('fotoArquivoEditarAluno');
    var fi = document.getElementById('fotoInput');
    var m = document.getElementById('miniatura');
    if (fa && fi && m && typeof initPhotoCrop === 'function') {
        initPhotoCrop(fa, { fotoInput: fi, miniatura: m, placeholder: null });
    }
});
</script>
{% endblock %}
