{% extends "base.html" %}
{% block title %}Vincular usuário como professor — {{ academia.nome }}{% endblock %}
{% block content %}
<div class="container mt-5">
    <div class="mb-4">
        {% set back_url = back_url or get_back_url_default() %}
{% include 'components/botao_voltar.html' %}
        <h2 class="h4 fw-bold text-dark">Vincular usuário como professor</h2>
        <p class="text-muted small">{{ academia.nome }}</p>
    </div>

    <div class="card shadow-sm" style="max-width: 600px;">
        <div class="card-body p-4">
            {% if usuarios %}
            <form method="POST">
                <div class="mb-4">
                    <label for="busca_usuario" class="form-label fw-semibold">Buscar usuário <span class="text-danger">*</span></label>
                    <div class="position-relative">
                        <input type="text" 
                               id="busca_usuario" 
                               class="form-control form-control-lg" 
                               placeholder="Digite o nome do usuário..."
                               autocomplete="off">
                        <input type="hidden" id="usuario_id" name="usuario_id" required>
                        <div id="lista_usuarios" class="list-group position-absolute w-100 shadow-lg" style="display: none; max-height: 300px; overflow-y: auto; z-index: 1000; top: 100%; margin-top: 2px;">
                            <!-- Lista será preenchida dinamicamente -->
                        </div>
                    </div>
                    <div id="usuario_selecionado" class="mt-2 p-2 bg-light rounded border d-none">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong id="nome_usuario_sel"></strong>
                                <small class="d-block text-muted" id="email_usuario_sel"></small>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="limpar_usuario">
                                <i class="bi bi-x"></i>
                            </button>
                        </div>
                    </div>
                    <small class="text-muted">Digite o nome do usuário para buscar. Apenas usuários ainda não vinculados como professor aparecem.</small>
                </div>
                
                <div class="mb-3">
                    <label for="nome" class="form-label fw-semibold">Nome</label>
                    <input type="text" id="nome" name="nome" class="form-control" readonly>
                    <small class="text-muted">Preenchido automaticamente do cadastro do usuário.</small>
                </div>
                
                <div class="mb-3">
                    <label for="email" class="form-label fw-semibold">E-mail</label>
                    <input type="email" id="email" name="email" class="form-control" readonly>
                    <small class="text-muted">Preenchido automaticamente do cadastro do usuário.</small>
                </div>
                
                <div class="mb-3">
                    <label for="telefone" class="form-label fw-semibold">Telefone (opcional)</label>
                    <input type="text" id="telefone" name="telefone" class="form-control" placeholder="(00) 00000-0000" maxlength="15">
                    <small class="text-muted">Preenchido automaticamente do cadastro do aluno, se disponível.</small>
                </div>
                {% if modalidades %}
                <div class="mb-4">
                    <label class="form-label fw-semibold">Modalidades</label>
                    <p class="small text-muted">Selecione as modalidades que o professor ministra (liberadas pela academia).</p>
                    <div class="d-flex flex-wrap gap-2">
                        {% for m in modalidades %}
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="modalidade_ids" value="{{ m.id }}" id="mod_prof_{{ m.id }}">
                            <label class="form-check-label" for="mod_prof_{{ m.id }}">{{ m.nome }}</label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                <div class="d-flex gap-2 pt-2">
                    {% set back_url = back_url or get_back_url_default() %}
{% include 'components/botao_voltar.html' %}
            {% endif %}
        </div>
    </div>
</div>
{% if usuarios %}
<script>
(function() {
    // Dados dos usuários disponíveis
    var usuarios = [
        {% for u in usuarios %}
        {
            id: {{ u.id }},
            nome: {{ u.nome|tojson }},
            email: {{ (u.email or '')|tojson }},
            telefone: {{ (u.telefone or '')|tojson }}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ];
    
    var buscaInput = document.getElementById('busca_usuario');
    var usuarioIdInput = document.getElementById('usuario_id');
    var listaUsuarios = document.getElementById('lista_usuarios');
    var usuarioSelecionado = document.getElementById('usuario_selecionado');
    var nomeUsuarioSel = document.getElementById('nome_usuario_sel');
    var emailUsuarioSel = document.getElementById('email_usuario_sel');
    var limparBtn = document.getElementById('limpar_usuario');
    var campoNome = document.getElementById('nome');
    var campoEmail = document.getElementById('email');
    var campoTelefone = document.getElementById('telefone');
    var timeoutBusca = null;
    var usuarioAtual = null;
    
    function filtrarUsuarios(termo) {
        if (!termo || termo.trim().length === 0) {
            return usuarios;
        }
        termo = termo.toLowerCase().trim();
        return usuarios.filter(function(u) {
            return (u.nome && u.nome.toLowerCase().indexOf(termo) >= 0) ||
                   (u.email && u.email.toLowerCase().indexOf(termo) >= 0);
        });
    }
    
    function exibirListaUsuarios(usuariosFiltrados) {
        listaUsuarios.innerHTML = '';
        if (usuariosFiltrados.length === 0) {
            listaUsuarios.innerHTML = '<div class="list-group-item text-muted text-center">Nenhum usuário encontrado</div>';
            listaUsuarios.style.display = 'block';
            return;
        }
        
        usuariosFiltrados.forEach(function(u) {
            var item = document.createElement('div');
            item.className = 'list-group-item list-group-item-action cursor-pointer';
            item.style.cursor = 'pointer';
            item.innerHTML = '<div><strong>' + (u.nome || '-') + '</strong><br><small class="text-muted">' + (u.email || 'Sem e-mail') + '</small></div>';
            item.addEventListener('click', function() {
                selecionarUsuario(u);
            });
            item.addEventListener('mouseenter', function() {
                this.classList.add('active');
            });
            item.addEventListener('mouseleave', function() {
                this.classList.remove('active');
            });
            listaUsuarios.appendChild(item);
        });
        listaUsuarios.style.display = 'block';
    }
    
    function selecionarUsuario(u) {
        usuarioAtual = u;
        usuarioIdInput.value = u.id;
        usuarioIdInput.setAttribute('value', u.id); // Garantir que o valor está definido
        campoNome.value = u.nome || '';
        campoEmail.value = u.email || '';
        
        var telefone = u.telefone || '';
        if (telefone) {
            campoTelefone.value = telefone.replace(/\D/g, '');
            aplicarMascaraTelefone(campoTelefone);
        } else {
            campoTelefone.value = '';
        }
        
        nomeUsuarioSel.textContent = u.nome || '-';
        emailUsuarioSel.textContent = u.email || 'Sem e-mail';
        usuarioSelecionado.classList.remove('d-none');
        buscaInput.classList.add('d-none');
        listaUsuarios.style.display = 'none';
        
        // Remover atributo required do campo de busca para não bloquear submit
        buscaInput.removeAttribute('required');
    }
    
    function limparSelecao() {
        usuarioAtual = null;
        usuarioIdInput.value = '';
        usuarioIdInput.removeAttribute('value');
        campoNome.value = '';
        campoEmail.value = '';
        campoTelefone.value = '';
        buscaInput.value = '';
        usuarioSelecionado.classList.add('d-none');
        buscaInput.classList.remove('d-none');
        listaUsuarios.style.display = 'none';
        buscaInput.focus();
    }
    
    buscaInput.addEventListener('input', function() {
        clearTimeout(timeoutBusca);
        var termo = this.value.trim();
        timeoutBusca = setTimeout(function() {
            var usuariosFiltrados = filtrarUsuarios(termo);
            exibirListaUsuarios(usuariosFiltrados);
        }, 150);
    });
    
    buscaInput.addEventListener('focus', function() {
        if (this.value.trim()) {
            var usuariosFiltrados = filtrarUsuarios(this.value.trim());
            exibirListaUsuarios(usuariosFiltrados);
        } else {
            // Mostrar todos os usuários quando focar sem texto
            exibirListaUsuarios(usuarios);
        }
    });
    
    buscaInput.addEventListener('blur', function() {
        // Delay para permitir clique na lista
        setTimeout(function() {
            listaUsuarios.style.display = 'none';
        }, 200);
    });
    
    limparBtn.addEventListener('click', limparSelecao);
    
    // Máscara de telefone
    function aplicarMascaraTelefone(input) {
        var v = input.value.replace(/\D/g, '');
        if (v.length > 11) v = v.slice(0, 11);
        
        if (v.length > 10) {
            input.value = '(' + v.slice(0,2) + ') ' + v.slice(2,7) + '-' + v.slice(7,11);
        } else if (v.length > 6) {
            input.value = '(' + v.slice(0,2) + ') ' + v.slice(2,6) + '-' + v.slice(6,10);
        } else if (v.length > 2) {
            input.value = '(' + v.slice(0,2) + ') ' + v.slice(2);
        } else if (v.length > 0) {
            input.value = '(' + v;
        } else {
            input.value = v;
        }
    }
    
    campoTelefone.addEventListener('input', function() {
        aplicarMascaraTelefone(this);
    });
    
    // Validação do formulário
    document.querySelector('form').addEventListener('submit', function(e) {
        if (!usuarioIdInput.value || usuarioIdInput.value.trim() === '') {
            e.preventDefault();
            alert('Por favor, selecione um usuário da lista.');
            if (buscaInput.classList.contains('d-none')) {
                limparSelecao();
            } else {
                buscaInput.focus();
            }
            return false;
        }
        // Garantir que os campos readonly sejam enviados
        if (!campoNome.value || !campoEmail.value) {
            e.preventDefault();
            alert('Erro: dados do usuário não foram carregados. Por favor, selecione novamente.');
            limparSelecao();
            return false;
        }
    });
    
    // Fechar lista ao clicar fora
    document.addEventListener('click', function(e) {
        if (!buscaInput.contains(e.target) && !listaUsuarios.contains(e.target)) {
            listaUsuarios.style.display = 'none';
        }
    });
})();
</script>
<style>
.cursor-pointer {
    cursor: pointer;
}
#lista_usuarios {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
}
#lista_usuarios .list-group-item {
    border-left: none;
    border-right: none;
    border-radius: 0;
}
#lista_usuarios .list-group-item:first-child {
    border-top: none;
}
#lista_usuarios .list-group-item:last-child {
    border-bottom: none;
}
#lista_usuarios .list-group-item:hover,
#lista_usuarios .list-group-item.active {
    background-color: #f8f9fa;
    color: #0d6efd;
}
</style>
{% endif %}
{% endblock %}
