{% extends "base.html" %}
{% block title %}Meu perfil — Editar cadastro e senha{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/photo-cropper.css') }}">
{% endblock %}
{% block content %}
<style>
  #miniaturaMeuPerfil { width: 120px; height: 120px; object-fit: cover; border-radius: 50%; border: 3px solid #0d6efd; }
  .camera-modal-meu-perfil { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; justify-content: center; align-items: center; background: rgba(0,0,0,.9); z-index: 9999; padding: 10px; }
  .camera-content-meu-perfil { width: 90%; max-width: 480px; text-align: center; }
  .camera-content-meu-perfil video, .camera-content-meu-perfil canvas { 
    width: 100%; 
    max-width: 100%;
    height: auto;
    max-height: 70vh;
    border-radius: 10px; 
    border: 2px solid #ddd; 
    margin-bottom: 10px;
    object-fit: contain;
    background: #000;
  }
  @media (max-width: 768px) {
    .camera-modal-meu-perfil { padding: 10px; }
    .camera-content-meu-perfil { width: 100%; max-width: 100%; }
    .camera-content-meu-perfil video, .camera-content-meu-perfil canvas { max-height: 60vh; }
    .camera-content-meu-perfil .btn { flex: 1 1 auto; min-width: 80px; font-size: 0.85rem; padding: 0.4rem; margin: 3px; }
    .camera-content-meu-perfil > div { display: flex; flex-wrap: wrap; justify-content: center; gap: 5px; }
  }
</style>
<div class="container mt-4">
  <div class="card shadow-sm border-0 mx-auto" style="max-width: 550px;">

    <div class="card-header bg-primary text-white py-3">
      <h5 class="mb-0 fw-bold">
        <i class="bi bi-person-gear me-2"></i> Configurações de usuário
      </h5>
    </div>

    <div class="card-body p-4">
      <form method="POST" enctype="multipart/form-data">
        <input type="hidden" name="next" value="{{ back_url }}">

        <!-- Foto -->
        <div class="mb-4">
          <label class="form-label fw-semibold"><i class="bi bi-camera-fill me-1"></i> Foto</label>
          <div class="d-flex flex-wrap align-items-start gap-4">
            <div class="text-center">
              <img id="miniaturaMeuPerfil" src="{{ url_for('static', filename='uploads/' + usuario.foto) if usuario.get('foto') else '' }}"
                   class="{{ 'd-block' if usuario.get('foto') else 'd-none' }} mx-auto"
                   alt="Foto" onerror="this.style.display='none'">
              <div id="placeholderFotoMeuPerfil" class="{{ 'd-none' if usuario.get('foto') else 'd-flex' }} align-items-center justify-content-center bg-light rounded-circle mx-auto" style="width:120px;height:120px;">
                <i class="bi bi-person-fill text-muted" style="font-size:3rem;"></i>
              </div>
              <input type="hidden" name="foto" id="fotoInputMeuPerfil">
            </div>
            <div class="flex-grow-1">
              <button type="button" class="btn btn-primary btn-sm mb-2" id="btnAbrirCameraMeuPerfil">
                <i class="bi bi-camera-fill me-1"></i> Tirar da câmera
              </button>
              <div class="mb-2">
                <label class="form-label small mb-0">ou escolher arquivo</label>
                <input type="file" name="foto_arquivo" class="form-control form-control-sm" accept="image/*" id="fotoArquivoMeuPerfil">
              </div>
              {% if aluno_vinculado and aluno_vinculado.foto %}
              <div class="mt-2 p-2 border rounded bg-light">
                <small class="text-muted d-block mb-1">
                  <i class="bi bi-info-circle me-1"></i> Você possui um aluno vinculado com foto cadastrada
                </small>
                <button type="button" class="btn btn-success btn-sm" id="btnSincronizarFoto">
                  <i class="bi bi-arrow-repeat me-1"></i> Sincronizar foto do aluno
                </button>
              </div>
              {% endif %}
            </div>
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label fw-semibold">Nome</label>
          <input type="text" name="nome" class="form-control" value="{{ usuario.nome or '' }}" required placeholder="Seu nome">
        </div>

        <div class="mb-3">
          <label class="form-label fw-semibold">E-mail</label>
          <input type="email" name="email" class="form-control" value="{{ usuario.email or '' }}" required placeholder="seu@email.com">
        </div>

        <div class="mb-4" id="campo-senha">
          <label class="form-label fw-semibold">Nova senha <span class="text-muted fw-normal">(opcional)</span></label>
          <input type="password" name="senha" id="senha" class="form-control" placeholder="Deixe em branco para manter a atual">
        </div>

        <div class="d-flex justify-content-between gap-2">
          {% set back_url = back_url or get_back_url_default() %}
          {% include 'components/botao_voltar.html' %}
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-check-lg me-1"></i> Salvar
          </button>
        </div>
      </form>

      <!-- Formulário separado para sincronizar foto do aluno -->
      {% if aluno_vinculado and aluno_vinculado.foto %}
      <form method="POST" action="{{ url_for('usuarios.sincronizar_foto_aluno') }}" id="formSincronizarFoto" style="display:none;">
        <input type="hidden" name="next" value="{{ back_url }}">
      </form>
      {% endif %}
    </div>

  </div>
</div>

<!-- Modal Câmera -->
<div class="camera-modal-meu-perfil" id="cameraModalMeuPerfil">
  <div class="camera-content-meu-perfil bg-dark p-3 rounded">
    <video id="cameraVideoMeuPerfil" autoplay playsinline></video>
    <canvas id="cameraCanvasMeuPerfil" style="display:none;"></canvas>
    <div>
      <button type="button" class="btn btn-success btn-sm" id="btnCapturarMeuPerfil">Capturar</button>
      <button type="button" class="btn btn-primary btn-sm" id="btnConfirmarFotoMeuPerfil" style="display:none;">Confirmar</button>
      <button type="button" class="btn btn-warning btn-sm" id="btnTirarNovamenteMeuPerfil" style="display:none;">Refazer</button>
      <button type="button" class="btn btn-info btn-sm text-white" id="btnTrocarCameraMeuPerfil" style="display:none;">
        <span id="btnTrocarCameraTextMeuPerfil">Trocar Câmera</span>
      </button>
      <button type="button" class="btn btn-danger btn-sm" id="btnFecharCameraMeuPerfil">Fechar</button>
    </div>
  </div>
</div>

<script>
(function() {
  var miniatura = document.getElementById('miniaturaMeuPerfil');
  var placeholder = document.getElementById('placeholderFotoMeuPerfil');
  var fotoInput = document.getElementById('fotoInputMeuPerfil');
  var fotoArquivo = document.getElementById('fotoArquivoMeuPerfil');

  function mostrarPreview(src) {
    if (miniatura) {
      miniatura.src = src;
      miniatura.classList.remove('d-none');
    }
    if (placeholder) placeholder.classList.add('d-none');
  }

  if (fotoArquivo) {
    fotoArquivo.addEventListener('change', function() {
      var f = this.files[0];
      if (f && f.type.indexOf('image') === 0) {
        var r = new FileReader();
        r.onload = function() { mostrarPreview(r.result); };
        r.readAsDataURL(f);
        if (fotoInput) fotoInput.value = '';
      }
    });
  }

  var streamMeuPerfil, devicesMeuPerfil = [], currentIndexMeuPerfil = 0, isFrontCameraMeuPerfil = false;
  var usingFrontCameraMeuPerfil = true;
  var frontCamerasMeuPerfil = [], backCamerasMeuPerfil = [], currentDeviceIdMeuPerfil = null;

  async function listarCamerasMeuPerfil() {
    try {
      // Solicitar permissão primeiro para obter labels dos dispositivos
      try {
        await navigator.mediaDevices.getUserMedia({ video: true });
      } catch (e) {
        console.error('Erro ao solicitar permissão:', e);
      }
      const medias = await navigator.mediaDevices.enumerateDevices();
      devicesMeuPerfil = medias.filter(d => d.kind === "videoinput");
      
      // Classificar câmeras em frontais e traseiras
      frontCamerasMeuPerfil = [];
      backCamerasMeuPerfil = [];
      for (var i = 0; i < devicesMeuPerfil.length; i++) {
        var device = devicesMeuPerfil[i];
        var label = device.label.toLowerCase();
        if (label.includes('front') || label.includes('facing') || label.includes('user')) {
          frontCamerasMeuPerfil.push(device);
        } else {
          backCamerasMeuPerfil.push(device);
        }
      }
      
      // Mostrar botão se houver múltiplas câmeras (mesmo que não identifiquemos claramente quais são frontais/traseiras)
      var temAmbas = frontCamerasMeuPerfil.length > 0 && backCamerasMeuPerfil.length > 0;
      var temMultiplas = devicesMeuPerfil.length > 1;
      var btnTrocar = document.getElementById('btnTrocarCameraMeuPerfil');
      if (btnTrocar) btnTrocar.style.display = temMultiplas ? 'inline-block' : 'none';
      
      // Se não identificamos ambas, definir texto padrão
      if (!temAmbas && temMultiplas) {
        var btnText = document.getElementById('btnTrocarCameraTextMeuPerfil');
        if (btnText) {
          btnText.textContent = 'Trocar Câmera';
        }
      }
    } catch (e) {
      console.error('Erro ao listar câmeras:', e);
    }
  }

  function atualizarTextoBotaoTrocarCameraMeuPerfil() {
    var btnText = document.getElementById('btnTrocarCameraTextMeuPerfil');
    if (btnText) {
      var temAmbas = frontCamerasMeuPerfil.length > 0 && backCamerasMeuPerfil.length > 0;
      if (temAmbas) {
        // Se identificamos ambas, usar texto dinâmico
        if (isFrontCameraMeuPerfil) {
          btnText.textContent = 'Câmera Traseira';
        } else {
          btnText.textContent = 'Câmera Dianteira';
        }
      } else {
        // Caso contrário, usar texto genérico
        btnText.textContent = 'Trocar Câmera';
      }
    }
  }

  async function abrirCameraMeuPerfil(deviceId = null) {
    var modalCam = document.getElementById('cameraModalMeuPerfil');
    var videoCam = document.getElementById('cameraVideoMeuPerfil');
    
    // Parar stream anterior completamente
    if (streamMeuPerfil) {
      try {
        streamMeuPerfil.getTracks().forEach(function(t) {
          t.stop();
        });
      } catch (e) {
        console.warn('Erro ao parar tracks:', e);
      }
      streamMeuPerfil = null;
    }
    
    // Limpar srcObject antes de iniciar novo stream
    videoCam.srcObject = null;
    
    // Aguardar um pouco mais para garantir que o stream anterior foi completamente liberado
    await new Promise(function(resolve) { setTimeout(resolve, 300); });

    var constraints = { video: true };
    var triedExact = false;
    if (deviceId) {
      // Verificar se o deviceId ainda existe na lista
      var deviceExists = devicesMeuPerfil.some(function(d) { return d.deviceId === deviceId; });
      if (deviceExists) {
        // Tentar primeiro com exact, se falhar tentar com ideal
        constraints.video = { deviceId: { exact: deviceId } };
        triedExact = true;
      } else {
        console.warn('DeviceId não encontrado, usando câmera padrão');
      }
    }

    try {
      streamMeuPerfil = await navigator.mediaDevices.getUserMedia(constraints);
      videoCam.srcObject = streamMeuPerfil;

      // Detectar tipo de câmera após stream estar ativo
      var track = streamMeuPerfil.getVideoTracks()[0];
      if (track) {
        var settings = track.getSettings();
        currentDeviceIdMeuPerfil = settings.deviceId;
        
        if (settings.facingMode === 'user') {
          isFrontCameraMeuPerfil = true;
        } else if (settings.facingMode === 'environment') {
          isFrontCameraMeuPerfil = false;
        } else {
          // Fallback: verificar se está na lista de frontais ou traseiras
          var device = devicesMeuPerfil.find(function(d) { return d.deviceId === currentDeviceIdMeuPerfil; });
          if (device) {
            var isInFront = frontCamerasMeuPerfil.some(function(d) { return d.deviceId === currentDeviceIdMeuPerfil; });
            var isInBack = backCamerasMeuPerfil.some(function(d) { return d.deviceId === currentDeviceIdMeuPerfil; });
            if (isInFront) {
              isFrontCameraMeuPerfil = true;
            } else if (isInBack) {
              isFrontCameraMeuPerfil = false;
            } else {
              // Tentar detectar pelo label
              var label = device.label.toLowerCase();
              isFrontCameraMeuPerfil = label.includes('front') || label.includes('facing') || label.includes('user');
            }
          } else {
            isFrontCameraMeuPerfil = false;
          }
        }
        
        // Aplicar transformação apenas para câmera frontal
        if (isFrontCameraMeuPerfil) {
          videoCam.style.transform = 'scaleX(-1)';
        } else {
          videoCam.style.transform = 'scaleX(1)';
        }
      }

      // Atualizar texto do botão de trocar câmera
      atualizarTextoBotaoTrocarCameraMeuPerfil();

      modalCam.style.display = 'flex';
      document.getElementById('cameraCanvasMeuPerfil').style.display = 'none';
      videoCam.style.display = 'block';
      document.getElementById('btnCapturarMeuPerfil').style.display = 'inline-block';
      document.getElementById('btnConfirmarFotoMeuPerfil').style.display = 'none';
      document.getElementById('btnTirarNovamenteMeuPerfil').style.display = 'none';
    } catch (e) {
      console.error('Erro ao acessar câmera com constraints:', e);
      
      // Se tentou com exact e falhou, tentar com ideal
      if (triedExact && deviceId) {
        try {
          constraints.video = { deviceId: { ideal: deviceId } };
          streamMeuPerfil = await navigator.mediaDevices.getUserMedia(constraints);
          videoCam.srcObject = streamMeuPerfil;
          
          var track = streamMeuPerfil.getVideoTracks()[0];
          if (track) {
            var settings = track.getSettings();
            currentDeviceIdMeuPerfil = settings.deviceId;
            
            if (settings.facingMode === 'user') {
              isFrontCameraMeuPerfil = true;
            } else if (settings.facingMode === 'environment') {
              isFrontCameraMeuPerfil = false;
            } else {
              var device = devicesMeuPerfil.find(function(d) { return d.deviceId === currentDeviceIdMeuPerfil; });
              if (device) {
                var isInFront = frontCamerasMeuPerfil.some(function(d) { return d.deviceId === currentDeviceIdMeuPerfil; });
                var isInBack = backCamerasMeuPerfil.some(function(d) { return d.deviceId === currentDeviceIdMeuPerfil; });
                if (isInFront) {
                  isFrontCameraMeuPerfil = true;
                } else if (isInBack) {
                  isFrontCameraMeuPerfil = false;
                } else {
                  var label = device.label.toLowerCase();
                  isFrontCameraMeuPerfil = label.includes('front') || label.includes('facing') || label.includes('user');
                }
              } else {
                isFrontCameraMeuPerfil = false;
              }
            }
          }
          
          if (isFrontCameraMeuPerfil) {
            videoCam.style.transform = 'scaleX(-1)';
          } else {
            videoCam.style.transform = 'scaleX(1)';
          }

          modalCam.style.display = 'flex';
          document.getElementById('cameraCanvasMeuPerfil').style.display = 'none';
          videoCam.style.display = 'block';
          document.getElementById('btnCapturarMeuPerfil').style.display = 'inline-block';
          document.getElementById('btnConfirmarFotoMeuPerfil').style.display = 'none';
          document.getElementById('btnTirarNovamenteMeuPerfil').style.display = 'none';
          return;
        } catch (e2) {
          console.error('Erro ao acessar câmera com ideal:', e2);
          // Se ainda falhar, tentar sem especificar deviceId
          try {
            constraints.video = true;
            streamMeuPerfil = await navigator.mediaDevices.getUserMedia(constraints);
            videoCam.srcObject = streamMeuPerfil;
            
            var track = streamMeuPerfil.getVideoTracks()[0];
            if (track) {
              var settings = track.getSettings();
              currentDeviceIdMeuPerfil = settings.deviceId;
              isFrontCameraMeuPerfil = settings.facingMode === 'user';
            }
            
            if (isFrontCameraMeuPerfil) {
              videoCam.style.transform = 'scaleX(-1)';
            } else {
              videoCam.style.transform = 'scaleX(1)';
            }
            
            atualizarTextoBotaoTrocarCameraMeuPerfil();
            modalCam.style.display = 'flex';
            document.getElementById('cameraCanvasMeuPerfil').style.display = 'none';
            videoCam.style.display = 'block';
            document.getElementById('btnCapturarMeuPerfil').style.display = 'inline-block';
            document.getElementById('btnConfirmarFotoMeuPerfil').style.display = 'none';
            document.getElementById('btnTirarNovamenteMeuPerfil').style.display = 'none';
            return;
          } catch (e3) {
            console.error('Erro ao acessar câmera padrão:', e3);
          }
        }
      }
      
      alert('Não foi possível acessar a câmera: ' + e.message);
    }
  }

  async function startCameraMeuPerfil() {
    if (streamMeuPerfil) {
      try {
        streamMeuPerfil.getTracks().forEach(function(t) { t.stop(); });
      } catch (e) {
        console.warn('Erro ao parar tracks:', e);
      }
      streamMeuPerfil = null;
    }

    var videoCam = document.getElementById('cameraVideoMeuPerfil');
    videoCam.srcObject = null;
    await new Promise(function(resolve) { setTimeout(resolve, 300); });

    var constraints = {
      video: { facingMode: usingFrontCameraMeuPerfil ? 'user' : 'environment' },
      audio: false
    };

    try {
      streamMeuPerfil = await navigator.mediaDevices.getUserMedia(constraints);
      videoCam.srcObject = streamMeuPerfil;
      isFrontCameraMeuPerfil = usingFrontCameraMeuPerfil;
      videoCam.style.transform = isFrontCameraMeuPerfil ? 'scaleX(-1)' : 'scaleX(1)';
      atualizarTextoBotaoTrocarCameraMeuPerfil();
      var btnTrocar = document.getElementById('btnTrocarCameraMeuPerfil');
      if (btnTrocar) btnTrocar.style.display = 'inline-block';
      document.getElementById('cameraModalMeuPerfil').style.display = 'flex';
      document.getElementById('cameraCanvasMeuPerfil').style.display = 'none';
      videoCam.style.display = 'block';
      document.getElementById('btnCapturarMeuPerfil').style.display = 'inline-block';
      document.getElementById('btnConfirmarFotoMeuPerfil').style.display = 'none';
      document.getElementById('btnTirarNovamenteMeuPerfil').style.display = 'none';
    } catch (e) {
      await listarCamerasMeuPerfil();
      await abrirCameraMeuPerfil(devicesMeuPerfil[0]?.deviceId);
    }
  }

  document.getElementById('btnAbrirCameraMeuPerfil').addEventListener('click', async function() {
    usingFrontCameraMeuPerfil = true;
    await startCameraMeuPerfil();
  });

  var btnTrocarMeuPerfil = document.getElementById('btnTrocarCameraMeuPerfil');
  if (btnTrocarMeuPerfil) {
    btnTrocarMeuPerfil.addEventListener('click', async function() {
      usingFrontCameraMeuPerfil = !usingFrontCameraMeuPerfil;
      await startCameraMeuPerfil();
    });
  }

  document.getElementById('btnFecharCameraMeuPerfil').addEventListener('click', function() {
    var modalCam = document.getElementById('cameraModalMeuPerfil');
    var videoCam = document.getElementById('cameraVideoMeuPerfil');
    modalCam.style.display = 'none';
    if (streamMeuPerfil) streamMeuPerfil.getTracks().forEach(function(t) { t.stop(); });
    videoCam.style.transform = '';
  });

  document.getElementById('btnCapturarMeuPerfil').addEventListener('click', function() {
    var videoCam = document.getElementById('cameraVideoMeuPerfil');
    var canvasCam = document.getElementById('cameraCanvasMeuPerfil');
    var ctx = canvasCam.getContext('2d');

    canvasCam.width = videoCam.videoWidth;
    canvasCam.height = videoCam.videoHeight;

    // Aplicar mesma transformação ao capturar (espelhar se for câmera frontal)
    if (isFrontCameraMeuPerfil) {
      ctx.translate(canvasCam.width, 0);
      ctx.scale(-1, 1);
    }
    ctx.drawImage(videoCam, 0, 0);

    canvasCam.style.display = 'block';
    videoCam.style.display = 'none';
    document.getElementById('btnCapturarMeuPerfil').style.display = 'none';
    document.getElementById('btnConfirmarFotoMeuPerfil').style.display = 'inline-block';
    document.getElementById('btnTirarNovamenteMeuPerfil').style.display = 'inline-block';
    var btnTrocar = document.getElementById('btnTrocarCameraMeuPerfil');
    if (btnTrocar) btnTrocar.style.display = 'none';
  });

  document.getElementById('btnTirarNovamenteMeuPerfil').addEventListener('click', function() {
    var videoCam = document.getElementById('cameraVideoMeuPerfil');
    var canvasCam = document.getElementById('cameraCanvasMeuPerfil');
    canvasCam.style.display = 'none';
    videoCam.style.display = 'block';
    document.getElementById('btnCapturarMeuPerfil').style.display = 'inline-block';
    document.getElementById('btnConfirmarFotoMeuPerfil').style.display = 'none';
    document.getElementById('btnTirarNovamenteMeuPerfil').style.display = 'none';
    var temMultiplas = devicesMeuPerfil.length > 1;
    var btnTrocar = document.getElementById('btnTrocarCameraMeuPerfil');
    if (btnTrocar) btnTrocar.style.display = temMultiplas ? 'inline-block' : 'none';
    atualizarTextoBotaoTrocarCameraMeuPerfil();
    // Restaurar transformação do video
    if (isFrontCameraMeuPerfil) {
      videoCam.style.transform = 'scaleX(-1)';
    } else {
      videoCam.style.transform = 'scaleX(1)';
    }
    var btnTrocar = document.getElementById('btnTrocarCameraMeuPerfil');
    if (btnTrocar) btnTrocar.style.display = devicesMeuPerfil.length > 1 ? 'inline-block' : 'none';
  });

  document.getElementById('btnConfirmarFotoMeuPerfil').addEventListener('click', function() {
    var dataURL = canvasCam.toDataURL('image/png');
    if (fotoInput) fotoInput.value = dataURL;
    mostrarPreview(dataURL);
    if (fotoArquivo) fotoArquivo.value = '';
    modalCam.style.display = 'none';
    if (streamMeuPerfil) streamMeuPerfil.getTracks().forEach(function(t) { t.stop(); });
  });

})();
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
<script src="{{ url_for('static', filename='js/photo-cropper.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  var fotoArquivo = document.getElementById('fotoArquivoMeuPerfil');
  var fotoInput = document.getElementById('fotoInputMeuPerfil');
  var miniatura = document.getElementById('miniaturaMeuPerfil');
  var placeholder = document.getElementById('placeholderFotoMeuPerfil');
  if (typeof initPhotoCrop === 'function' && fotoArquivo) {
    initPhotoCrop(fotoArquivo, { fotoInput: fotoInput, miniatura: miniatura, placeholder: placeholder });
  }

  // Botão de sincronizar foto do aluno
  var btnSincronizar = document.getElementById('btnSincronizarFoto');
  if (btnSincronizar) {
    btnSincronizar.addEventListener('click', function() {
      if (confirm('Deseja sincronizar a foto do seu cadastro de aluno para o seu perfil de usuário?')) {
        var formSincronizar = document.getElementById('formSincronizarFoto');
        if (formSincronizar) {
          formSincronizar.submit();
        }
      }
    });
  }
});
</script>
{% endblock %}
