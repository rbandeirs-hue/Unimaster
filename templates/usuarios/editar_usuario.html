{% extends "base.html" %}
{% block title %}Editar Usuário{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/photo-cropper.css') }}">
{% endblock %}
{% block content %}

<style>
  #miniaturaUsuario { width: 120px; height: 120px; object-fit: cover; border-radius: 50%; border: 3px solid #ffc107; }
  .camera-modal-usuario { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; justify-content: center; align-items: center; background: rgba(0,0,0,.9); z-index: 9999; padding: 10px; }
  .camera-content-usuario { width: 90%; max-width: 480px; text-align: center; }
  .camera-content-usuario video, .camera-content-usuario canvas { 
    width: 100%; 
    max-width: 100%;
    height: auto;
    max-height: 70vh;
    border-radius: 10px; 
    border: 2px solid #ddd; 
    margin-bottom: 10px;
    object-fit: contain;
    background: #000;
  }
  .camera-content-usuario .btn { margin: 5px; }
  @media (max-width: 768px) {
    .camera-modal-usuario { padding: 10px; }
    .camera-content-usuario { width: 100%; max-width: 100%; }
    .camera-content-usuario video, .camera-content-usuario canvas { max-height: 60vh; }
    .camera-content-usuario .btn { flex: 1 1 auto; min-width: 80px; font-size: 0.85rem; padding: 0.4rem; margin: 3px; }
    .camera-content-usuario > div { display: flex; flex-wrap: wrap; justify-content: center; gap: 5px; }
  }
</style>

<div class="container mt-4">
  <div class="card shadow-lg border-0 mx-auto" style="max-width: 650px;">

    <div class="card-header bg-warning text-dark text-center py-3">
      <h5 class="mb-0 fw-bold">
        <i class="bi bi-pencil-square me-2"></i> Editar Usuário
      </h5>
    </div>

    <div class="card-body p-4">

      <form method="POST" enctype="multipart/form-data">
        <input type="hidden" name="next" value="{{ back_url }}">

        <!-- Foto -->
        <div class="mb-4">
          <label class="form-label fw-semibold"><i class="bi bi-camera-fill me-1"></i> Foto</label>
          <div class="d-flex flex-wrap align-items-start gap-4">
            <div class="text-center">
              <img id="miniaturaUsuario" src="{{ url_for('static', filename='uploads/' + usuario.foto) if usuario.get('foto') else '' }}"
                   class="{{ 'd-block' if usuario.foto else 'd-none' }} mx-auto"
                   alt="Foto" onerror="this.style.display='none'">
              <div id="placeholderFoto" class="{{ 'd-none' if usuario.get('foto') else 'd-flex' }} align-items-center justify-content-center bg-light rounded-circle mx-auto" style="width:120px;height:120px;">
                <i class="bi bi-person-fill text-muted" style="font-size:3rem;"></i>
              </div>
              <input type="hidden" name="foto" id="fotoInputUsuario">
            </div>
            <div class="flex-grow-1">
              <button type="button" class="btn btn-primary btn-sm mb-2" id="btnAbrirCameraUsuario">
                <i class="bi bi-camera-fill me-1"></i> Tirar da câmera
              </button>
              <div class="mb-2">
                <label class="form-label small mb-0">ou escolher arquivo</label>
                <input type="file" name="foto_arquivo" class="form-control form-control-sm" accept="image/*" id="fotoArquivoUsuario">
              </div>
            </div>
          </div>
        </div>

        <!-- Nome (somente leitura) -->
        <div class="mb-3">
          <label class="form-label fw-semibold">Nome</label>
          <input type="text" class="form-control" value="{{ usuario.nome }}" disabled>
        </div>

        <!-- Email (somente leitura) -->
        <div class="mb-3">
          <label class="form-label fw-semibold">Email</label>
          <input type="email" class="form-control" value="{{ usuario.email }}" disabled>
        </div>

        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <label class="form-label fw-semibold">Nova Senha (opcional)</label>
            <input type="password" name="senha" class="form-control" placeholder="••••••">
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label fw-semibold">Níveis de Acesso (Roles)</label>
          <div class="row g-2">
            {% for role in roles %}
            <div class="col-12 col-md-6">
              <div class="form-check">
                <input class="form-check-input role-cb" type="checkbox" name="roles" id="role_{{ role.id }}"
                       value="{{ role.id }}" data-chave="{{ role.chave or role.nome|lower }}"
                       {% if role.id in roles_do_usuario %}checked{% endif %}>
                <label class="form-check-label" for="role_{{ role.id }}">
                  {{ role.nome }}
                </label>
              </div>
            </div>
            {% endfor %}
          </div>
          <div class="form-text">Marque as roles que o usuário deve ter.</div>
        </div>

        {% if contexto_academia %}
        <div id="blocoAluno" class="mb-3" style="display:none;">
          <label for="aluno_id" class="form-label fw-semibold">Qual aluno é este usuário?</label>
          <select class="form-select" id="aluno_id" name="aluno_id">
            <option value="">— Selecione o aluno —</option>
            {% for a in alunos_para_aluno %}
            <option value="{{ a.id }}" {% if a.id == aluno_vinculado_id %}selected{% endif %}>{{ a.nome }}</option>
            {% endfor %}
          </select>
        </div>
        <div id="blocoResponsavel" class="mb-3" style="display:none;">
          <label class="form-label fw-semibold">Alunos vinculados ao responsável</label>
          <div class="border rounded p-3" style="max-height: 200px; overflow-y: auto; background: #f8fafc;">
            {% for a in alunos_para_responsavel %}
            <div class="form-check mb-2">
              <input class="form-check-input" type="checkbox" name="aluno_ids" value="{{ a.id }}" id="aluno_resp_{{ a.id }}"
                     {% if a.id in responsavel_aluno_ids %}checked{% endif %}>
              <label class="form-check-label" for="aluno_resp_{{ a.id }}">{{ a.nome }}</label>
            </div>
            {% endfor %}
          </div>
        </div>
        <div id="blocoVisitante" class="mb-3" style="display:none;">
          <div class="alert alert-info mb-0">
            <i class="bi bi-info-circle me-2"></i>
            <strong>Visitante:</strong> 
            {% if visitante_dados %}
            Este usuário já possui registro de visitante na academia.
            <br><small class="text-muted">
              Aulas realizadas: {{ visitante_dados.aulas_experimentais_realizadas or 0 }}
              {% if visitante_dados.aulas_experimentais_permitidas %}
              / {{ visitante_dados.aulas_experimentais_permitidas }}
              {% else %}
              (sem limite)
              {% endif %}
            </small>
            {% else %}
            Ao salvar, será criado um registro de visitante vinculado à primeira academia do usuário.
            {% endif %}
          </div>
        </div>
        {% endif %}

        {% if mostrar_academias and academias_disponiveis %}
        <div class="mb-3">
          <label class="form-label fw-semibold">Academias vinculadas</label>
          {% if academias_bloqueadas %}
          <div class="alert alert-secondary small py-2 mb-0">
            <i class="bi bi-lock-fill me-1"></i> No modo academia não é possível alterar academias vinculadas.
          </div>
          {% endif %}
          <div class="row g-2">
            {% for ac in academias_disponiveis %}
            <div class="col-12 col-md-6">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="academias" id="academia_{{ ac.id }}" value="{{ ac.id }}"
                       {% if ac.id in (academias_vinculadas_ids or []) %}checked{% endif %}
                       {% if academias_bloqueadas %}disabled{% endif %}>
                <label class="form-check-label {% if academias_bloqueadas %}text-muted{% endif %}" for="academia_{{ ac.id }}">{{ ac.nome }}</label>
              </div>
            </div>
            {% endfor %}
          </div>
          {% if not academias_bloqueadas %}
          <div class="form-text">Marque as academias às quais o usuário terá acesso.</div>
          {% endif %}
        </div>
        {% endif %}

        <div class="d-flex justify-content-between mt-4">
          <button type="submit" class="btn btn-warning">
            <i class="bi bi-save me-2"></i> Salvar
          </button>

          {% set back_url = back_url or get_back_url_default() %}
          {% include 'components/botao_voltar.html' %}
        </div>

      </form>

    </div>

  </div>
</div>
{% if contexto_academia %}
<script>
(function() {
    var blocoAluno = document.getElementById('blocoAluno');
    var blocoResponsavel = document.getElementById('blocoResponsavel');
    function temRole(chave) {
        var cbs = document.querySelectorAll('.role-cb:checked');
        for (var i = 0; i < cbs.length; i++) {
            if ((cbs[i].dataset.chave || '').toLowerCase() === chave) return true;
        }
        return false;
    }
    var blocoVisitante = document.getElementById('blocoVisitante');
    function atualizarBlocos() {
        if (blocoAluno) blocoAluno.style.display = temRole('aluno') ? 'block' : 'none';
        if (blocoResponsavel) blocoResponsavel.style.display = temRole('responsavel') ? 'block' : 'none';
        if (blocoVisitante) blocoVisitante.style.display = temRole('visitante') ? 'block' : 'none';
    }
    document.querySelectorAll('.role-cb').forEach(function(cb) {
        cb.addEventListener('change', atualizarBlocos);
    });
    atualizarBlocos();
})();
</script>
{% endif %}

<!-- Modal Câmera (d-flex só via JS ao abrir — senão d-flex sobrescreve display:none e modal aparece ao carregar) -->
<div class="camera-modal-usuario" id="cameraModalUsuario">
  <div class="camera-content-usuario bg-dark p-3 rounded">
    <video id="cameraVideoUsuario" autoplay playsinline></video>
    <canvas id="cameraCanvasUsuario" style="display:none;"></canvas>
    <div>
      <button type="button" class="btn btn-success btn-sm" id="btnCapturarUsuario">Capturar</button>
      <button type="button" class="btn btn-primary btn-sm" id="btnConfirmarFotoUsuario" style="display:none;">Confirmar</button>
      <button type="button" class="btn btn-warning btn-sm" style="display:none;" id="btnTirarNovamenteUsuario">Refazer</button>
      <button type="button" class="btn btn-info btn-sm text-white" id="btnTrocarCameraUsuario" style="display:none;">
        <span id="btnTrocarCameraTextUsuario">Trocar Câmera</span>
      </button>
      <button type="button" class="btn btn-danger btn-sm" id="btnFecharCameraUsuario">Fechar</button>
    </div>
  </div>
</div>

<script>
(function() {
  var miniatura = document.getElementById('miniaturaUsuario');
  var placeholder = document.getElementById('placeholderFoto');
  var fotoInput = document.getElementById('fotoInputUsuario');
  var fotoArquivo = document.getElementById('fotoArquivoUsuario');

  function mostrarPreview(src) {
    if (miniatura) {
      miniatura.src = src;
      miniatura.classList.remove('d-none');
    }
    if (placeholder) placeholder.classList.add('d-none');
  }


  var streamUsuario, devicesUsuario = [], currentIndexUsuario = 0, isFrontCameraUsuario = false;
  var usingFrontCameraUsuario = true;
  var frontCamerasUsuario = [], backCamerasUsuario = [], currentDeviceIdUsuario = null;

  async function listarCamerasUsuario() {
    try {
      // Solicitar permissão primeiro para obter labels dos dispositivos
      try {
        await navigator.mediaDevices.getUserMedia({ video: true });
      } catch (e) {
        console.error('Erro ao solicitar permissão:', e);
      }
      const medias = await navigator.mediaDevices.enumerateDevices();
      devicesUsuario = medias.filter(d => d.kind === "videoinput");
      
      // Classificar câmeras em frontais e traseiras
      frontCamerasUsuario = [];
      backCamerasUsuario = [];
      for (var i = 0; i < devicesUsuario.length; i++) {
        var device = devicesUsuario[i];
        var label = device.label.toLowerCase();
        if (label.includes('front') || label.includes('facing') || label.includes('user')) {
          frontCamerasUsuario.push(device);
        } else {
          backCamerasUsuario.push(device);
        }
      }
      
      // Mostrar botão se houver múltiplas câmeras (mesmo que não identifiquemos claramente quais são frontais/traseiras)
      var temAmbas = frontCamerasUsuario.length > 0 && backCamerasUsuario.length > 0;
      var temMultiplas = devicesUsuario.length > 1;
      var btnTrocar = document.getElementById('btnTrocarCameraUsuario');
      if (btnTrocar) btnTrocar.style.display = temMultiplas ? 'inline-block' : 'none';
      
      // Se não identificamos ambas, definir texto padrão
      if (!temAmbas && temMultiplas) {
        var btnText = document.getElementById('btnTrocarCameraTextUsuario');
        if (btnText) {
          btnText.textContent = 'Trocar Câmera';
        }
      }
    } catch (e) {
      console.error('Erro ao listar câmeras:', e);
    }
  }

  function atualizarTextoBotaoTrocarCameraUsuario() {
    var btnText = document.getElementById('btnTrocarCameraTextUsuario');
    if (btnText) {
      var temAmbas = frontCamerasUsuario.length > 0 && backCamerasUsuario.length > 0;
      if (temAmbas) {
        // Se identificamos ambas, usar texto dinâmico
        if (isFrontCameraUsuario) {
          btnText.textContent = 'Câmera Traseira';
        } else {
          btnText.textContent = 'Câmera Dianteira';
        }
      } else {
        // Caso contrário, usar texto genérico
        btnText.textContent = 'Trocar Câmera';
      }
    }
  }

  async function abrirCameraUsuario(deviceId = null) {
    var modalCam = document.getElementById('cameraModalUsuario');
    var videoCam = document.getElementById('cameraVideoUsuario');
    
    // Parar stream anterior completamente
    if (streamUsuario) {
      try {
        streamUsuario.getTracks().forEach(function(t) {
          t.stop();
        });
      } catch (e) {
        console.warn('Erro ao parar tracks:', e);
      }
      streamUsuario = null;
    }
    
    // Limpar srcObject antes de iniciar novo stream
    videoCam.srcObject = null;
    
    // Aguardar um pouco mais para garantir que o stream anterior foi completamente liberado
    await new Promise(function(resolve) { setTimeout(resolve, 300); });

    var constraints = { video: true };
    var triedExact = false;
    if (deviceId) {
      // Verificar se o deviceId ainda existe na lista
      var deviceExists = devicesUsuario.some(function(d) { return d.deviceId === deviceId; });
      if (deviceExists) {
        // Tentar primeiro com exact, se falhar tentar com ideal
        constraints.video = { deviceId: { exact: deviceId } };
        triedExact = true;
      } else {
        console.warn('DeviceId não encontrado, usando câmera padrão');
      }
    }

    try {
      streamUsuario = await navigator.mediaDevices.getUserMedia(constraints);
      videoCam.srcObject = streamUsuario;

      // Detectar tipo de câmera após stream estar ativo
      var track = streamUsuario.getVideoTracks()[0];
      if (track) {
        var settings = track.getSettings();
        currentDeviceIdUsuario = settings.deviceId;
        
        if (settings.facingMode === 'user') {
          isFrontCameraUsuario = true;
        } else if (settings.facingMode === 'environment') {
          isFrontCameraUsuario = false;
        } else {
          // Fallback: verificar se está na lista de frontais ou traseiras
          var device = devicesUsuario.find(function(d) { return d.deviceId === currentDeviceIdUsuario; });
          if (device) {
            var isInFront = frontCamerasUsuario.some(function(d) { return d.deviceId === currentDeviceIdUsuario; });
            var isInBack = backCamerasUsuario.some(function(d) { return d.deviceId === currentDeviceIdUsuario; });
            if (isInFront) {
              isFrontCameraUsuario = true;
            } else if (isInBack) {
              isFrontCameraUsuario = false;
            } else {
              // Tentar detectar pelo label
              var label = device.label.toLowerCase();
              isFrontCameraUsuario = label.includes('front') || label.includes('facing') || label.includes('user');
            }
          } else {
            isFrontCameraUsuario = false;
          }
        }
        
        // Aplicar transformação apenas para câmera frontal
        if (isFrontCameraUsuario) {
          videoCam.style.transform = 'scaleX(-1)';
        } else {
          videoCam.style.transform = 'scaleX(1)';
        }
      }

      modalCam.style.display = 'flex';
      document.getElementById('cameraCanvasUsuario').style.display = 'none';
      videoCam.style.display = 'block';
      document.getElementById('btnCapturarUsuario').style.display = 'inline-block';
      document.getElementById('btnConfirmarFotoUsuario').style.display = 'none';
      document.getElementById('btnTirarNovamenteUsuario').style.display = 'none';
    } catch (e) {
      console.error('Erro ao acessar câmera com constraints:', e);
      
      // Se tentou com exact e falhou, tentar com ideal
      if (triedExact && deviceId) {
        try {
          constraints.video = { deviceId: { ideal: deviceId } };
          streamUsuario = await navigator.mediaDevices.getUserMedia(constraints);
          videoCam.srcObject = streamUsuario;
          
          var track = streamUsuario.getVideoTracks()[0];
          if (track) {
            var settings = track.getSettings();
            currentDeviceIdUsuario = settings.deviceId;
            
            if (settings.facingMode === 'user') {
              isFrontCameraUsuario = true;
            } else if (settings.facingMode === 'environment') {
              isFrontCameraUsuario = false;
            } else {
              var device = devicesUsuario.find(function(d) { return d.deviceId === currentDeviceIdUsuario; });
              if (device) {
                var isInFront = frontCamerasUsuario.some(function(d) { return d.deviceId === currentDeviceIdUsuario; });
                var isInBack = backCamerasUsuario.some(function(d) { return d.deviceId === currentDeviceIdUsuario; });
                if (isInFront) {
                  isFrontCameraUsuario = true;
                } else if (isInBack) {
                  isFrontCameraUsuario = false;
                } else {
                  var label = device.label.toLowerCase();
                  isFrontCameraUsuario = label.includes('front') || label.includes('facing') || label.includes('user');
                }
              } else {
                isFrontCameraUsuario = false;
              }
            }
          }
          
          if (isFrontCameraUsuario) {
            videoCam.style.transform = 'scaleX(-1)';
          } else {
            videoCam.style.transform = 'scaleX(1)';
          }

          atualizarTextoBotaoTrocarCameraUsuario();
          modalCam.style.display = 'flex';
          document.getElementById('cameraCanvasUsuario').style.display = 'none';
          videoCam.style.display = 'block';
          document.getElementById('btnCapturarUsuario').style.display = 'inline-block';
          document.getElementById('btnConfirmarFotoUsuario').style.display = 'none';
          document.getElementById('btnTirarNovamenteUsuario').style.display = 'none';
          return;
        } catch (e2) {
          console.error('Erro ao acessar câmera com ideal:', e2);
          // Se ainda falhar, tentar sem especificar deviceId
          try {
            constraints.video = true;
            streamUsuario = await navigator.mediaDevices.getUserMedia(constraints);
            videoCam.srcObject = streamUsuario;
            
            var track = streamUsuario.getVideoTracks()[0];
            if (track) {
              var settings = track.getSettings();
              currentDeviceIdUsuario = settings.deviceId;
              isFrontCameraUsuario = settings.facingMode === 'user';
            }
            
            if (isFrontCameraUsuario) {
              videoCam.style.transform = 'scaleX(-1)';
            } else {
              videoCam.style.transform = 'scaleX(1)';
            }
            
            atualizarTextoBotaoTrocarCameraUsuario();
            modalCam.style.display = 'flex';
            document.getElementById('cameraCanvasUsuario').style.display = 'none';
            videoCam.style.display = 'block';
            document.getElementById('btnCapturarUsuario').style.display = 'inline-block';
            document.getElementById('btnConfirmarFotoUsuario').style.display = 'none';
            document.getElementById('btnTirarNovamenteUsuario').style.display = 'none';
            return;
          } catch (e3) {
            console.error('Erro ao acessar câmera padrão:', e3);
          }
        }
      }
      
      alert('Não foi possível acessar a câmera: ' + e.message);
    }
  }

  async function startCameraUsuario() {
    if (streamUsuario) {
      try {
        streamUsuario.getTracks().forEach(function(t) { t.stop(); });
      } catch (e) {
        console.warn('Erro ao parar tracks:', e);
      }
      streamUsuario = null;
    }

    var videoCam = document.getElementById('cameraVideoUsuario');
    videoCam.srcObject = null;
    await new Promise(function(resolve) { setTimeout(resolve, 300); });

    var constraints = {
      video: { facingMode: usingFrontCameraUsuario ? 'user' : 'environment' },
      audio: false
    };

    try {
      streamUsuario = await navigator.mediaDevices.getUserMedia(constraints);
      videoCam.srcObject = streamUsuario;
      isFrontCameraUsuario = usingFrontCameraUsuario;
      videoCam.style.transform = isFrontCameraUsuario ? 'scaleX(-1)' : 'scaleX(1)';
      atualizarTextoBotaoTrocarCameraUsuario();
      var btnTrocar = document.getElementById('btnTrocarCameraUsuario');
      if (btnTrocar) btnTrocar.style.display = 'inline-block';
      document.getElementById('cameraModalUsuario').style.display = 'flex';
      document.getElementById('cameraCanvasUsuario').style.display = 'none';
      videoCam.style.display = 'block';
      document.getElementById('btnCapturarUsuario').style.display = 'inline-block';
      document.getElementById('btnConfirmarFotoUsuario').style.display = 'none';
      document.getElementById('btnTirarNovamenteUsuario').style.display = 'none';
    } catch (e) {
      await listarCamerasUsuario();
      await abrirCameraUsuario(devicesUsuario[0]?.deviceId);
    }
  }

  document.getElementById('btnAbrirCameraUsuario').addEventListener('click', async function() {
    usingFrontCameraUsuario = true;
    await startCameraUsuario();
  });

  var btnTrocarUsuario = document.getElementById('btnTrocarCameraUsuario');
  if (btnTrocarUsuario) {
    btnTrocarUsuario.addEventListener('click', async function() {
      usingFrontCameraUsuario = !usingFrontCameraUsuario;
      await startCameraUsuario();
    });
  }

  document.getElementById('btnFecharCameraUsuario').addEventListener('click', function() {
    var modalCam = document.getElementById('cameraModalUsuario');
    var videoCam = document.getElementById('cameraVideoUsuario');
    modalCam.style.display = 'none';
    if (streamUsuario) streamUsuario.getTracks().forEach(function(t) { t.stop(); });
    videoCam.style.transform = '';
  });

  document.getElementById('btnCapturarUsuario').addEventListener('click', function() {
    var videoCam = document.getElementById('cameraVideoUsuario');
    var canvasCam = document.getElementById('cameraCanvasUsuario');
    var ctx = canvasCam.getContext('2d');

    canvasCam.width = videoCam.videoWidth;
    canvasCam.height = videoCam.videoHeight;

    // Aplicar mesma transformação ao capturar (espelhar se for câmera frontal)
    if (isFrontCameraUsuario) {
      ctx.translate(canvasCam.width, 0);
      ctx.scale(-1, 1);
    }
    ctx.drawImage(videoCam, 0, 0);

    canvasCam.style.display = 'block';
    videoCam.style.display = 'none';
    document.getElementById('btnCapturarUsuario').style.display = 'none';
    document.getElementById('btnConfirmarFotoUsuario').style.display = 'inline-block';
    document.getElementById('btnTirarNovamenteUsuario').style.display = 'inline-block';
    var btnTrocar = document.getElementById('btnTrocarCameraUsuario');
    if (btnTrocar) btnTrocar.style.display = 'none';
  });

  document.getElementById('btnTirarNovamenteUsuario').addEventListener('click', function() {
    var videoCam = document.getElementById('cameraVideoUsuario');
    var canvasCam = document.getElementById('cameraCanvasUsuario');
    canvasCam.style.display = 'none';
    videoCam.style.display = 'block';
    document.getElementById('btnCapturarUsuario').style.display = 'inline-block';
    document.getElementById('btnConfirmarFotoUsuario').style.display = 'none';
    document.getElementById('btnTirarNovamenteUsuario').style.display = 'none';
    // Restaurar transformação do video
    if (isFrontCameraUsuario) {
      videoCam.style.transform = 'scaleX(-1)';
    } else {
      videoCam.style.transform = 'scaleX(1)';
    }
    var temMultiplas = devicesUsuario.length > 1;
    var btnTrocar = document.getElementById('btnTrocarCameraUsuario');
    if (btnTrocar) btnTrocar.style.display = temMultiplas ? 'inline-block' : 'none';
    atualizarTextoBotaoTrocarCameraUsuario();
  });

  document.getElementById('btnConfirmarFotoUsuario').addEventListener('click', function() {
    var dataURL = canvasCam.toDataURL('image/png');
    if (fotoInput) fotoInput.value = dataURL;
    mostrarPreview(dataURL);
    if (fotoArquivo) fotoArquivo.value = '';
    modalCam.style.display = 'none';
    if (streamUsuario) streamUsuario.getTracks().forEach(function(t) { t.stop(); });
  });
})();
</script>
{% endblock %}
{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
<script src="{{ url_for('static', filename='js/photo-cropper.js') }}"></script>
<script>
(function(){
  var fa = document.getElementById('fotoArquivoUsuario');
  var fi = document.getElementById('fotoInputUsuario');
  var m = document.getElementById('miniaturaUsuario');
  var p = document.getElementById('placeholderFoto');
  if (fa && fi && typeof initPhotoCrop === 'function') {
    initPhotoCrop(fa, { fotoInput: fi, miniatura: m, placeholder: p });
  }
})();
</script>
{% endblock %}
