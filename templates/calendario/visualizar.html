{% extends "base.html" %}
{% block title %}Calendário — {{ contexto.nome }}{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/calendario.css') }}">
{% endblock %}
{% block content %}
<div class="container-fluid px-2 px-md-3 mt-3 mt-md-4 calendario-page">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3 calendario-header-page">
        <div class="flex-grow-1">
            {% if nivel == 'associacao' %}
            {% set back_url = back_url or get_back_url_default() %}
{% include 'components/botao_voltar.html' %}
            {% elif nivel == 'federacao' %}
            {% set back_url = back_url or get_back_url_default() %}
{% include 'components/botao_voltar.html' %}
            {% elif nivel == 'academia' %}
            {% set back_url = back_url or get_back_url_default() %}
{% include 'components/botao_voltar.html' %}
            {% endif %}
            <h2 class="h5 fw-bold text-primary mb-1">Calendário — {{ contexto.nome }}</h2>
            <p class="text-muted small mb-0">Visualização e gestão de eventos</p>
        </div>
        <div class="btn-group flex-wrap">
            <a href="{{ url_for('calendario.sincronizar') }}" class="btn btn-outline-primary btn-sm">
                <i class="bi bi-arrow-repeat"></i> <span class="d-none d-sm-inline">Sincronizar</span>
            </a>
            <a href="{{ url_for('calendario.novo_evento') }}" class="btn btn-primary btn-sm">
                <i class="bi bi-plus-lg"></i> <span class="d-none d-sm-inline">Novo</span>
            </a>
            <a href="{{ url_for('calendario.lista_eventos') }}" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-list-ul"></i> <span class="d-none d-sm-inline">Lista</span>
            </a>
            {% if nivel in ['associacao', 'academia'] %}
            <a href="{{ url_for('calendario.aprovacoes') }}" class="btn btn-outline-info btn-sm">
                <i class="bi bi-clipboard-check"></i>
            </a>
            {% endif %}
            {% if nivel == 'academia' %}
            <a href="{{ url_for('calendario.conflitos_aula_feriado') }}" class="btn btn-outline-warning btn-sm" title="Conflitos Aula x Feriado">
                <i class="bi bi-exclamation-triangle"></i>
            </a>
            {% endif %}
        </div>
    </div>

    <!-- Navegação de mês -->
    <div class="card shadow-sm mb-3">
        <div class="card-body py-3">
            <div class="calendario-nav">
                {% set mes_anterior = mes - 1 if mes > 1 else 12 %}
                {% set ano_anterior = ano if mes > 1 else ano - 1 %}
                {% set mes_proximo = mes + 1 if mes < 12 else 1 %}
                {% set ano_proximo = ano if mes < 12 else ano + 1 %}
                
                <a href="{{ url_for('calendario.visualizar', nivel=nivel, nivel_id=nivel_id, mes=mes_anterior, ano=ano_anterior) }}" 
                   class="btn btn-outline-secondary btn-sm">
                    <i class="bi bi-chevron-left"></i>
                </a>
                
                <h4 class="mb-0 fw-bold">
                    {% set meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'] %}
                    {% set meses_full = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'] %}
                    <span class="d-none d-md-inline">{{ meses_full[mes - 1] }} de {{ ano }}</span>
                    <span class="d-md-none">{{ meses[mes - 1] }}/{{ ano }}</span>
                </h4>
                
                <a href="{{ url_for('calendario.visualizar', nivel=nivel, nivel_id=nivel_id, mes=mes_proximo, ano=ano_proximo) }}" 
                   class="btn btn-outline-secondary btn-sm">
                    <i class="bi bi-chevron-right"></i>
                </a>
            </div>
        </div>
    </div>

    <!-- Calendário -->
    <div class="card shadow-sm">
        <div class="card-body p-0">
            <div class="calendario-grid">
                <div class="calendario-header">
                    <div class="calendario-dia-semana"><span class="d-none d-sm-inline">Dom</span><span class="d-sm-none">D</span></div>
                    <div class="calendario-dia-semana"><span class="d-none d-sm-inline">Seg</span><span class="d-sm-none">S</span></div>
                    <div class="calendario-dia-semana"><span class="d-none d-sm-inline">Ter</span><span class="d-sm-none">T</span></div>
                    <div class="calendario-dia-semana"><span class="d-none d-sm-inline">Qua</span><span class="d-sm-none">Q</span></div>
                    <div class="calendario-dia-semana"><span class="d-none d-sm-inline">Qui</span><span class="d-sm-none">Q</span></div>
                    <div class="calendario-dia-semana"><span class="d-none d-sm-inline">Sex</span><span class="d-sm-none">S</span></div>
                    <div class="calendario-dia-semana"><span class="d-none d-sm-inline">Sáb</span><span class="d-sm-none">S</span></div>
                </div>

                <div class="calendario-body">
                    {% set mes_ajustado = mes - 2 if mes > 2 else mes + 10 %}
                    {% set ano_ajustado = ano if mes > 2 else ano - 1 %}
                    {% set dia_semana_inicio = ((1 + ((13 * mes_ajustado - 1) // 5) + ano_ajustado + (ano_ajustado // 4) + (ano_ajustado // 400) - (ano_ajustado // 100)) % 7) %}
                    {% set ultimo_dia = 31 if mes in [1, 3, 5, 7, 8, 10, 12] else (30 if mes in [4, 6, 9, 11] else (29 if ano % 4 == 0 and (ano % 100 != 0 or ano % 400 == 0) else 28)) %}
                    
                    {% for i in range(dia_semana_inicio) %}
                    <div class="calendario-celula vazia"></div>
                    {% endfor %}
                    
                    {% for dia in range(1, ultimo_dia + 1) %}
                        {% set data_str = '%04d-%02d-%02d'|format(ano, mes, dia) %}
                        {% set eventos_dia = eventos_por_data.get(data_str, []) %}
                        {% set hoje = data_str == hoje_str %}
                        
                        <div class="calendario-celula {% if hoje %}hoje{% endif %}" data-data="{{ data_str }}">
                            <div class="numero-dia">{{ dia }}</div>
                            {% if eventos_dia %}
                            <div class="eventos-lista">
                                {% for evento in eventos_dia[:3] %}
                                <div class="evento-item" style="border-left-color: {{ evento.cor or '#0d6efd' }};">
                                    {% if evento.hora_inicio %}<span class="evento-horario">{{ evento.hora_inicio.strftime('%H:%M') if evento.hora_inicio.__class__.__name__ == 'time' else evento.hora_inicio }}{% if evento.hora_fim %}–{{ evento.hora_fim.strftime('%H:%M') if evento.hora_fim.__class__.__name__ == 'time' else evento.hora_fim }}{% endif %} </span>{% endif %}
                                    <span class="evento-titulo">{{ evento.titulo }}{% if evento.tipo == 'feriado' %} <i class="bi bi-star-fill text-warning"></i>{% elif evento.tipo == 'aula' %} <i class="bi bi-book"></i>{% endif %}</span>
                                </div>
                                {% endfor %}
                                {% if eventos_dia|length > 3 %}
                                <div class="evento-mais">+{{ eventos_dia|length - 3 }}</div>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Lista de eventos do mês (visível só em mobile) -->
    <div class="calendario-lista-mes card shadow-sm mt-3">
        <div class="card-header py-2">
            <strong>Eventos do mês</strong>
        </div>
        <div class="list-group list-group-flush">
            {% set meses_abrev = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'] %}
            {% if not eventos_por_data %}
            <div class="list-group-item text-muted text-center py-4">Nenhum evento neste mês</div>
            {% endif %}
            {% for data_str in eventos_por_data.keys()|sort %}
                {% for evento in eventos_por_data[data_str] %}
                <div class="list-group-item list-group-item-action evento-lista-item py-2">
                    <div class="evento-lista-data">
                        <span class="dia">{{ data_str[-2:] }}</span>
                        <span class="mes">{{ meses_abrev[data_str[5:7]|int - 1] }}</span>
                    </div>
                        <div class="evento-lista-conteudo">
                        <div class="evento-lista-titulo">
                            {% if evento.hora_inicio %}<strong class="text-primary">{{ evento.hora_inicio|hora_fmt }}{% if evento.hora_fim %}–{{ evento.hora_fim|hora_fmt }}{% endif %}</strong> — {% endif %}{{ evento.titulo }}
                            {% if evento.tipo == 'feriado' %}<i class="bi bi-star-fill text-warning ms-1"></i>{% elif evento.tipo == 'aula' %}<i class="bi bi-book text-primary ms-1"></i>{% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% endfor %}
        </div>
    </div>

    <!-- Legenda -->
    <div class="card shadow-sm mt-3">
        <div class="card-body py-2 py-md-3 calendario-legenda">
            <h6 class="fw-bold mb-2 small">Legenda:</h6>
            <div class="d-flex flex-wrap gap-3">
                <div><i class="bi bi-star-fill text-warning"></i> Feriado</div>
                <div><i class="bi bi-book text-primary"></i> Aula</div>
                <div><i class="bi bi-calendar-event text-info"></i> Evento</div>
                <div><i class="bi bi-trophy text-success"></i> Competição</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
